---
title: "CM_Report_Figures"
author: "Caitlin C. Mothes, PhD"
date: "2024-05-28"
output:
  word_document:
      reference_docx: "NRR_Full_Template_V4.2.docx"
---

```{r setup, include=FALSE}
# set chunk defaults
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      fig.width = 8)
                      
                      
# read in libraries
source("setup.R")
library(scales)
library(tmap)

# set parameters
## path to data folder (from project directory)
path <- "data/park/"
## park code for this report
park <- "BRCA"


# read in data
load(paste0(path, "/", park, "/", park, "_report_data.RData"))
## terra object issue when saving as .RData, so saved as separate .tif
wbm_30y <- terra::rast(paste0(path, "/", park, "/", park, "_wbm_30yr_annual_rasters.tif"))
```

# Title Page

```{r}
knitr::include_graphics("data/all/Report_Figures/BRCA.avif")
```


\newpage


30 Year Change Maps
```{r}
# calculate change rasters (%) for runoff
runoff_change_rasters <- map2(rep(scen, 2), c(rep("2040_2069", 2), rep("2070_2099", 2)), function(x, y) {
  (wbm_30y[[grepl(pattern = paste(select_cfs[select_cfs$CF == x, GCM], "runoff", y, sep = "_"),
                  x = names(wbm_30y))]] - wbm_30y[[grepl(
                    pattern = paste("gridmet_historical", "runoff", "1981_2010", sep = "_"),
                    x = names(wbm_30y)
                  )]]) / wbm_30y[[grepl(
                    pattern = paste("gridmet_historical", "runoff", "1981_2010", sep = "_"),
                    x = names(wbm_30y)
                  )]] * 100
}) %>% terra::rast() %>% 
  crop(st_buffer(st_transform(park_boundary, crs(.)), 10000))


# create palette, this is how you would control all maps to be on the same max/min scale
# runoff_change_palette <- c(
#   colorRampPalette(colors = c("darkred", "darkgray"), space = "Lab")(abs(min(
#     values(runoff_change_rasters), na.rm = TRUE
#   ))),
#   colorRampPalette(
#     colors = c("darkgray", "dodgerblue"),
#     space = "Lab"
#   )(max(values(runoff_change_rasters), na.rm = TRUE))
# )


# create all figures
runoff_change_maps <- map2(rep(scen, 2), c(rep("2040_2069", 2), rep("2070_2099", 2)), function(x, y) {
  tm_shape(runoff_change_rasters[[grepl(
    pattern = paste(select_cfs[select_cfs$CF == x, GCM], "runoff", y, sep = "_"),
    x = names(runoff_change_rasters)
  )]]) +
    tm_raster(
      style = "cont",
      palette = c("darkred", "darkgrey", "dodgerblue"),
      n = 6,
      midpoint = 0,
      legend.reverse = TRUE,
      title = paste0("Predicted Change in\nRunoff for ", y),
      legend.format = list(
        fun = function(z)
          paste0(formatC(
            z, digits = 0, format = "f"
          ), " %")
      )
    ) +
    tm_shape(park_boundary) +
    tm_borders(col = "black") +
    tm_shape(st_union(watersupply_watershed)) +
    tm_borders(col = "yellow") +
    #tm_compass(position = "right", size = 0.75) +
    tm_scale_bar() +
    tm_add_legend("fill",
                  col = "yellow",
                  labels = "Water Supply Watershed")+
    tm_layout(
      title = x,
      frame = FALSE,
      legend.outside = TRUE,
      legend.outside.size = 0.5
    )
})

tmap_arrange(runoff_change_maps, ncol = 2, outer.margins = 0.01)

```


BRCA Water Supply Figure
```{r}
# map of BRCA, water supply watershed, NPS PODs

## Need this package for basemaps
library(maptiles)

## Get all BRCA NPS PODs
POD_all <- POD_state %>% filter(UNIT_CODE == "BRCA" & park_right == "Park") %>% 
  distinct(WRNUM, .keep_all = TRUE)


## Download tiles and compose basemap raster
tile_maps <- get_tiles(x = park_boundary, provider =  "Esri.WorldTerrain")


## Create map
tm_shape(tile_maps) + 
  tm_rgb() +
  tm_shape(park_boundary) +
  tm_polygons(col = "darkgreen", alpha = 0.25) +
  tm_shape(st_union(watersupply_watershed)) +
  tm_borders(col = "yellow", lwd = 5) +
  tm_shape(POD_all) +
  tm_dots(col = "black",
          alpha = 0.75,
          size = 0.25) +
  tm_shape(POD_supply) +
  tm_dots(col = "red", size = 0.5) +
  tm_scale_bar() +
  tm_add_legend("fill", col = "yellow", labels = "Water Supply Watershed") +
  tm_add_legend("symbol", col = "black", labels = "All NPS PODs") +
  tm_add_legend("symbol", col = "red", labels = "BRCA Water Supply") +
  tm_layout(
    title = "BRCA Water Supply",
    frame = FALSE,
    legend.outside = TRUE,
    legend.outside.size = 0.5,
    outer.margins = 0.01
  )

```


