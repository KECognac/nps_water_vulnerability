---
title: "Proj_Visitation"
author: "KEC"
date: "2024-04-04"
output: html_document
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: 79
---

This is a subset of code from the CCVA_Processing script that can be used to
test new methods for predicting visitation and water demands at a national
park. Currently, it is hardcoded to inport Bryce Canyon data, but I (Kristen)
am happy to expand it to test other parks. Currently, we just haven't explored
water use data for other parks in detail.

# Setup Script

```{r setup}

# read in data
source('Setup.R')
load('data/Visitation_Demand_Projections/BRCA_dat.Rdata')

library(ggpubr)
library(scales)

```

The goal of this effort is to develop a model to estimate national park water
use at individual parks. Ideally, we would have a model that performs well at
both annual and monthly timesteps that can be projected into the future up to
at least 2080. Because visitation is a major driver of water use at national
parks, we start by developing visitation models. We then use the best
visitation model as an input to models for water use. Notably, water use is
synonymous with water demand herein.

## Develop statistical models to project future visitation.

Start with a simple linear model to project historic trends in annual park
visitation into the future.

```{r linear_model, echo = FALSE, warning = FALSE, fig.height = 3, fig.width = 7}
 
# Calculate linear model
visitor_lm <- lm(TotalVisitors ~ log(y), 
                 data = centroid_annual %>%
                          filter(y < 2023))

# Add projected visitation to centroid_annual and centroid monthly datasets
centroid_annual_p <- centroid_annual %>%
 cbind(., predict(visitor_lm, centroid_annual, 
                  interval = "confidence") %>%
          `colnames<-`(c( "TotalVisitors_lm_fit", 
                          "TotalVisitors_lm_lwr",
                          "TotalVisitors_lm_upr"))) 

# Plot results

ggplot(centroid_annual_p %>% 
         filter (y <= 2080), 
       aes(x = y)) +
  geom_point(aes(y = TotalVisitors, color = "Historical")) + 
  geom_line(aes(y = TotalVisitors, color = "Historical")) +
  geom_line(aes(y = TotalVisitors_lm_fit, color = "Linear Model")) + 
  geom_ribbon(aes(ymin = TotalVisitors_lm_lwr,
                  ymax = TotalVisitors_lm_upr),
                  fill = "gray",
              alpha = 0.2) +
  labs(x = "", y = "Annual Visitors") + 
  scale_y_continuous(labels = unit_format(unit = "k", scale = 1e-3)) +
  scale_color_manual("", values = c("black","red")) +
  theme_bw()

```

While this trend might be fine for the annual projections, it's not going to
work for monthly projections. So, need to explore other options.

Temperature has been identified as a strong predictor of visitation trends at
national parks (Fisichelli et al., 2015).

Fisichelli NA, Schuurman GW, Monahan WB, Ziesler PS (2015) Protected Area
Tourism in a Changing Climate: Will Visitation at US National Parks Warm Up or
Overheat? PLoS ONE 10(6): e0128226.https://doi.org/10.1371/journal.pone.0128226

Start by plotting monthly proportions to see if park visitor data follow
temperature relationships identified by Fisichelli et al., 2015. Currently,
we're using the mean of max daily temperatures (tmax_F) of each month as the
input for this test, but we also tested the mean of the mean daily temp and got
a similar result.

```{r monthly_proportion, echo = FALSE, warning = FALSE, fig.height = 3, fig.width = 5}

monthly_proportion <- centroid_monthly %>%
  mutate(y = year(ym)) %>%
  dplyr::filter(y < 2024) %>%
  group_by(y) %>%
  mutate(vis_sum = sum(TotalVisitors, na.rm = TRUE),
         monthly_vis_prop = TotalVisitors/vis_sum,
         dem_sum = sum(use_acre_feet, na.rm = TRUE),
         monthly_dem_prop = use_acre_feet/dem_sum,
         tmax_c = (tmax_f - 32)*5/9) 

a <- ggplot(monthly_proportion) + geom_boxplot(aes(x = floor(tmax_c), 
                                                   y = monthly_vis_prop, 
                                                   group = floor(tmax_c))) + 
  labs(x = "",
       y = "Monthly visitation (proportion)") + 
  theme_bw( )

b <- ggplot(monthly_proportion) + geom_boxplot(aes(x = floor(tmax_c), 
                                                   y = monthly_dem_prop, 
                                                   group = floor(tmax_c))) + 
  labs(x = "", 
       y = "Monthly water demand (proportion)",
       title = "") +
  theme_bw()

fig <- ggarrange(a,b,nrow = 1)
annotate_figure(fig, 
                bottom = text_grob("Monthly Temperature (C)"),
                top = text_grob(park_boundary$UNIT_NAME))
```

The figure above shows that monthly visitation does not exhibit the
characteristic relationship identified by Fisichelli et al wherein visitation
decreases over some threshold temperature. It does appear to level out after
some temperature though.

Next, we develop a multiple linear regression model using independent variables
of: mean monthly temperature, \# of days per month with temperatures \>= 77F,
and the year to predict \# monthly park visitors. Notably, year serves as an
indicator of population trends through time. Including year produces an R2 =
0.869 while not including it produces a max R2 of 0.69. In the future, we
should explore other variables that we can project into the future to represent
population changes.

```{r MLR_monthly, echo = FALSE, warning = FALSE}

# identify regression variables
visitor_regress <- purrr::map(
 # Elements to iterate over
  centroid_monthly %>% 
    dplyr::filter(year(ym) < 2024) %>%
    dplyr::select(-c(ym, gcm, cf, unit_climate_zone,TotalVisitors)),
  ~lm(TotalVisitors ~ .x, data = centroid_monthly %>%
        dplyr::filter(year(ym) < 2024))) %>%
  purrr::map(broom::glance) %>%
  dplyr::bind_rows(.id = "variable") %>%
  dplyr::select(variable, r.squared) %>%
  arrange(.,desc(r.squared))



# Develop a multiple linear regression model 
# First create transform variables for model

# Function to create a population curve from the year. The "2000" can be 
# modified to change where the population curve peaks. May want to explore more
pop_curve <- function(year, k = 0.1, L = 20) {
  ymean <- mean(year, na.rm = TRUE)
  pop <- (L / (1 + exp(-k * (year - 2000)))) + 1
}

# Add new variabls to df
centroid_monthly <- centroid_monthly %>%
                   mutate(TotalVisitorsLog = log(TotalVisitors),
                          y = year(ym), 
                          m = month(ym),
                          pop = pop_curve(y)) 


# Develop model
visitor_mlr = lm(formula = TotalVisitorsLog ~ 
                    tavg_f +
                    days_gt_77F +
                    days_lt_32F +
                    pop,
                   data = centroid_monthly %>%
                   filter(year(ym) <= 2023))

print(summary(visitor_mlr))


# Add projections to monthly dataframe
centroid_monthly <- 
  mutate(centroid_monthly,
            TotalVisitors_mlr_fit = exp(predict(visitor_mlr, centroid_monthly)),
            TotalVisitors_mlr_lwr = exp(predict(visitor_mlr, centroid_monthly, 
                                            interval = "confidence")[,2]),
            TotalVisitors_mlr_upr = exp(predict(visitor_mlr, centroid_monthly, 
                                            interval = "confidence")[,3]),
         TotalVisitors_all = case_when(year(ym) < 2024 ~ TotalVisitors,
                                       year(ym) >= 2024 ~ TotalVisitors_mlr_fit),
         TotalVisitorsLog = log(TotalVisitors_all))


if ("TotalVisitors_mlr_fit" %in% names(centroid_annual)) {
          centroid_annual <- centroid_annual %>%
          dplyr::select(-c(TotalVisitors_mlr_fit,TotalVisitors_mlr_lwr,TotalVisitors_mlr_upr))
 }

# Sum and add to annual dataset
centroid_annual <- centroid_monthly %>%
  dplyr::select(-c(ym,gcm,unit_climate_zone)) %>%
  group_by(y,cf) %>%
  dplyr::summarize(TotalVisitors_mlr_fit = sum(TotalVisitors_mlr_fit, na.rm = FALSE),
            TotalVisitors_mlr_lwr = sum(TotalVisitors_mlr_lwr, na.rm = FALSE),
            TotalVisitors_mlr_upr = sum(TotalVisitors_mlr_upr, na.rm = FALSE),
            .groups = "keep") %>%
  left_join(., centroid_annual, by = c("y","cf")) %>%
  mutate(TotalVisitors_all = case_when(y < 2024 ~ TotalVisitors,
                                       y >= 2024 ~ TotalVisitors_mlr_fit),
         TotalVisitors_log = log(TotalVisitors_all))


# Plot monthly visitors
ggplot(centroid_monthly %>% filter(year(ym) < 2070)) + 
  geom_line(aes(x = ym, 
                y = TotalVisitors_mlr_fit, 
                color = cf), 
            size = 1) +
  geom_ribbon(aes(x = ym, 
                  ymin = TotalVisitors_mlr_lwr, 
                  ymax = TotalVisitors_mlr_upr),
              alpha = 0.3,
              fill = "hotpink") +
  geom_line(aes(x = ym, 
                y = TotalVisitors,color = "historical_actual"), 
            size = 1) + 
  scale_color_manual("",
                     values = c("hotpink","black","red","cornflowerblue"), 
                     labels = c("MLR Model","Historical","Hot Dry", "Warm Wet" )) + 
  labs(x = "", y = "Total Monthly Visitors", title = park) + 
  theme_bw() #+ coord_trans(y = "log10") 

#ggsave('data/Test_Figures/Visitors_Proj_Model.jpg', width = 8, height = 4, units = c("in"),
 #      dpi = 600)

annual_visitor_summary <- centroid_annual %>%
  dplyr::select(y,cf,TotalVisitors_all) %>%
  dplyr::filter(y >= 2000) %>%
  group_by(cf) %>%
  drop_na(TotalVisitors_all) %>%
  dplyr::summarize(sens_slope = trend::sens.slope(TotalVisitors_all)$estimates[1],
                   pval = trend::sens.slope(TotalVisitors_all)$p.value,
                   mean = mean(TotalVisitors_all),
                   percent_chg = 100*trend::sens.slope(TotalVisitors_all)$estimates[1] / mean(TotalVisitors_all)) %>%
  mutate(text = case_when(sens_slope < 0 & pval < 0.05 ~ paste0("decreased on average by ",round(percent_chg,1)," % per year"),
                          sens_slope > 0 & pval < 0.05 ~ paste0("increased on average by ",round(percent_chg,1)," % per year"),
                          sens_slope == 0 | pval > 0.05 ~ "not significantly changed"))
```



Calculate demand stats and develop models to predict future visitation

```{r demand_per_visitor, fig.width = 5, fig.height = 4, warning = FALSE, echo = FALSE}


# Start by looking at general trends in use and per person demand

a <- ggplot(centroid_monthly %>% filter(year(ym) < 2024),
            aes(x = ym, y = demand_pp_gal)) + 
  geom_point(color = "dodgerblue") +
  geom_smooth(color = "dodgerblue4",fill = "dodgerblue4") + 
  labs(y = "Monthly", x = "", 
       title = "      Water Use (gallons per person)") +
  theme_bw()

b <- ggplot(centroid_annual %>% filter(y < 2024), 
            aes(x = y, y = demand_pp_gal)) + 
  geom_point(color = "dodgerblue") + 
  geom_smooth(color = "dodgerblue4",fill = "dodgerblue", span = 1) + 
  labs(y = "Annual", x = "") +
  theme_bw()

ggarrange(a,b, nrow = 2)


```

Next, develop models to predict future water demand per person. Start by
calibrating a model using historic water use data. Then, project model into
future.

Next, Develop models to predict future water demand .

```{r, fig.width = 5}

# First create calibrated model with historic data then project.

# Next try multiple linear regression which uses multiple inputs
demand_mlr_model = lm(formula = use_acre_feet ~ 
                    tmax_f +
                    days_lt_32F +
                   TotalVisitorsLog +
                     pet_in,
                 data = centroid_monthly %>%
                              filter(year(ym) < 2023) %>%
                              mutate(use_acre_feet = 
                                ifelse(use_acre_feet == 0, NA, use_acre_feet)))

print(summary(demand_mlr_model))

centroid_monthly <- 
  mutate(centroid_monthly,
            MLR_demand_fit = predict(demand_mlr_model, centroid_monthly),
            MLR_demand_lwr = predict(demand_mlr_model, centroid_monthly, 
                                     interval = "confidence")[,2],
            MLR_demand_upr = predict(demand_mlr_model, centroid_monthly, 
                                     interval = "confidence")[,3],
         demand_all = case_when(year(ym) < 2024 ~ use_acre_feet,
                                year(ym) > 2024 ~ MLR_demand_fit))


# How does it do for annual predictions
demand_annual <- centroid_monthly %>%
  dplyr::select(c('y','use_acre_feet','MLR_demand_fit','cf')) %>%
  group_by(y,cf) %>%
  summarize_all(list(sum))

r_squared <- cor(na.omit(demand_annual) %>% pull(use_acre_feet), 
                 na.omit(demand_annual) %>% pull(MLR_demand_fit))^2

print(r_squared)


# identify regression variables
use_regress_annual <- purrr::map(
 # Elements to iterate over
  centroid_annual %>% 
    ungroup() %>%
    dplyr::filter(y < 2024) %>%
    dplyr::select(-c(gcm, cf, unit_climate_zone, use_acre_feet)),
  ~lm(use_acre_feet ~ .x, data = centroid_annual %>%
        dplyr::filter(y < 2024))) %>%
  purrr::map(broom::glance) %>%
  dplyr::bind_rows(.id = "variable") %>%
  dplyr::select(variable, r.squared) %>%
  arrange(.,desc(r.squared))


# multiple linear regression
demand_mlr_modelA = lm(formula = use_acre_feet ~ 
                    tavg_f +
                    days_gt_95roff + 
                    TotalVisitors_all+
                     aet_in +
                     snow_in,
                 data = centroid_annual %>%
                        filter(y < 2023) %>%
                        mutate(use_acre_feet = 
                            ifelse(use_acre_feet == 0, NA, use_acre_feet)))

summary(demand_mlr_modelA)

centroid_annual <- centroid_annual %>%
  mutate(MLR_demandA_fit = predict(demand_mlr_modelA, newdata = centroid_annual),
         MLR_demandA_lwr = predict(demand_mlr_modelA, newdata = centroid_annual, interval = "confidence")[,2],
         MLR_demandA_upr = predict(demand_mlr_modelA, newdata = centroid_annual, interval = "confidence")[,3],
         demand_all = case_when(y < 2024 ~ use_acre_feet,
                                y > 2024 ~ MLR_demandA_fit))


# Plot both models for yearly values

# Doesn't do great for annual water use -- so develop separate annual model
a <- ggplot(demand_annual %>% 
         filter(y < 2025) %>%
         mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA, use_acre_feet)) %>%
         drop_na(use_acre_feet) %>%
         pivot_longer(cols = -c(y,cf), names_to = 'vars', values_to = 'vals'),
         aes(x = y, y = vals, color = vars)) + 
  geom_line(size = 1) + 
  scale_color_manual("", values = c("hotpink","black"),
                         labels = c("MLR Model","Actual")) + 
  labs(x = "", y = "Annual Water Use (af)", title = "Monthly Model") +
  theme_bw()

b <- ggplot(centroid_annual  %>% 
         filter(y < 2025) %>%
         mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA, use_acre_feet)) %>%
         drop_na(use_acre_feet)) + 
  geom_line(aes(x = y, y = use_acre_feet,
             color = "Actual Use"), size = 1) +
geom_line(aes(x = y, 
              y = MLR_demandA_fit,
             color = "MLR Model"), size = 1) +
  scale_color_manual("", values = c("black","hotpink")) +
  labs(x = "", y = "Annual Water Use", title = "Annual Model") + theme_bw() 

ggarrange(a,b,nrow = 2)

ggsave(paste0('data/Test_Figures/Demand_Historic_Annual_',park,'.jpg'), width = 8, height = 4, units = c("in"),
       dpi = 600)


# Plot projections
ggplot(centroid_annual %>%
         mutate(use_acre_feet = ifelse(use_acre_feet == 0, NA,
                                       use_acre_feet))) +
  geom_line(aes(x = y, y = MLR_demandA_fit, color = cf)) +
  geom_ribbon(aes(x = y, ymin =  MLR_demandA_lwr, ymax =  MLR_demandA_upr, 
              color = cf, fill = cf), alpha = 0.2, linewidth = 0) + 
  geom_line(aes(x = y, 
                y = use_acre_feet),
                color = "black") + 
  scale_color_manual("Modeled", values = c("gray80","red","dodgerblue4")) +
  scale_fill_manual("Modeled", values = c("gray80","red","dodgerblue4")) +
  labs(x = "", y = "Annual Water Demand (af)") + 
  xlim(1980,2080) + theme_bw()

#ggsave('data/Test_Figures/Demand_Projected_Model_Annual_model.jpg', width = 8, height = 4, units = c("in"),
#       dpi = 600)

# Plot Monthly

ggplot(centroid_monthly) +
  geom_line(data = centroid_monthly,aes(x = ym, y = MLR_demand_fit, color = cf)) +
  geom_ribbon(data = centroid_monthly,aes(x = ym, ymin =  MLR_demand_lwr, ymax =  MLR_demand_upr, 
              fill = cf), alpha = 0.6, linewidth = 0) + 
  geom_line(data = centroid_monthly %>% filter(year(ym)<2023),
            aes(x = ym, 
                y = use_acre_feet, 
                color = gcm)) + 
  scale_color_manual("", values = c("black","hotpink","red","dodgerblue4")) +
  scale_fill_manual("",values = c("hotpink","red","dodgerblue4")) +
  labs(x = "", y = "Monthly Water Demand (af)") + 
  theme_bw() #+ scale_y_log10() 

#ggsave('data/Test_Figures/Demand_Projected_Model_Monthly_model.jpg', width = 8, height = 4, units = c("in"),
 #      dpi = 600)


# Calculate stats for monthly per person demand for years 2000-2023. Note,
# historic data only
monthly_pp_demand <- centroid_monthly %>%
  dplyr::filter(year(ym) > 2000) %>%
  drop_na(demand_pp_gal) %>%
  mutate(use_gal = use_acre_feet * 325851) %>%
  dplyr::summarize(sens_slope = trend::sens.slope(demand_pp_gal)$estimates[1],
                   pval = trend::sens.slope(demand_pp_gal)$p.value,
                   mean = mean(demand_pp_gal)) %>%
  mutate(percent_chg = 100 * sens_slope / mean,
    text = case_when(sens_slope < 0 & pval < 0.05 ~ paste0("reduced on average by ",round(percent_chg,1),"% per-person per-year.  These reductions likely reflect successful conservation efforts."),
                          sens_slope > 0 & pval < 0.05 ~ paste0("increased on average by ",round(percent_chg,1)," % per year.  These increases may indicate a need to fortify conservation efforts and focus on inefficiencies in the system."),
                          sens_slope == 0 | pval > 0.05 ~ "did not significantly change."))

# Calculate stats summary for annual water use / demand. For historic, only use
# years 2000-2023 to avoid non-linear trends from too far back.
annual_use_summary <- centroid_annual %>%
  dplyr::select(y,cf,demand_all) %>%
  #dplyr::filter(y >= 2000) %>%
  mutate(demand_gal = demand_all * 325851) %>%
  group_by(cf) %>%
  drop_na(demand_all) %>%
  dplyr::summarize(sens_slope = trend::sens.slope(demand_gal)$estimates[1],
                   pval = trend::sens.slope(demand_gal)$p.value,
                   mean = mean(demand_gal)) %>%
  mutate(percent_chg = 100 * sens_slope / mean,
    text = case_when(sens_slope < 0 & pval < 0.05 ~ paste0("decreased on average by ",round(percent_chg,1)," % per year"),
                          sens_slope > 0 & pval < 0.05 ~ paste0("increased on average by ",round(percent_chg,1)," % per year"),
                          sens_slope == 0 | pval > 0.05 ~ "though the long term trend was neither increasing nor decreasing."))

```