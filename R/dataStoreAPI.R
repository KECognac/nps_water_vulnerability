# search and download data from IRMA Data Store with REST Api


# use httr and jsonlite to make GET requests, parse results and page through data
library(httr)
library(jsonlite)


call <- "https://irmaservices.nps.gov/datastore/v4/rest"


# test call using single reference ID (use DEVA HIS)
deva_his <- httr::GET(paste0(call, "/Profile/2286975"))

#structure of content
str(content(deva_his))

#convert content to text
deva_his_txt <- content(deva_his, "text", encoding = "UTF-8")

#parse data in JSON
deva_his_json <- fromJSON(deva_his_txt,
                          flatten = TRUE)


# extract referenceID (for example, even though we already know this)
refID <- deva_his_json$referenceId


# search linked resources to get dataset id for download
deva_his_res <- httr::GET(paste0(call, "/Reference/", refID, "/DigitalFiles"))

#extract resourceID
resContent <- content(deva_his_res)

resID <- resContent[[1]]$resourceId


#download file
#data <- httr::GET(paste0(call, "/DownloadFile/", resID))

download.file(paste0(call, "/DownloadFile/", resID), destfile = "data/deva_his.zip", method = "curl")
