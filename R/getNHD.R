#' Import NHD data for park
#' 
#' This function uses the nhdplusTools package to import flowline, catchments and
#' water body spatial data for parks, within a specified buffer distance around
#' the park boundary
#' 
#' @param aoi An sf polygon object, often a park boundary (or boundaries) retrieved from `getParkBoundary()`.
#' @param dist The buffer distance (in decimal degrees) around park boundaries to filter NHD data to
#' @param save Whether to save (TRUE) the resulting shapefile or not (FALSE)
#' @param path If `save = TRUE`, the file path to save the shapefiles as well as their names.
#' 
#' @return A list of spatial sf objects, one for flowlines, cactchments and water bodies
#' 
#' @seealso [getParkBoundary()]
getNHD <- function(aoi, dist, save = FALSE, path){
  
  sf::sf_use_s2(FALSE)
  
  aoi <- aoi %>% 
    sf::st_buffer(dist = dist)
  
  # get flowlines
  nhd_flowlines <- list()
  
  for(i in 1:nrow(aoi)){
    nhd_flowlines[[i]] <- nhdplusTools::get_nhdplus(AOI = aoi[i,], 
                                                realization='flowline')
  }
    
  nhd_flowlines <- do.call('rbind',nhd_flowlines) %>% #dplyr::bind_rows(nhd_flowlines)
    sf::st_intersection(.,dplyr::select(aoi, UNIT_CODE))

  # get catchments 
  nhd_catchments <- list()
  
  for(i in 1:nrow(aoi)){
    nhd_catchments[[i]] <- nhdplusTools::get_nhdplus(AOI = aoi[i,], 
                                                    realization='catchment')
  }
  
  nhd_catchments <- do.call('rbind',nhd_catchments) %>%
    sf::st_intersection(.,dplyr::select(aoi, UNIT_CODE))
  
  # get waterbodies
  nhd_waterbodies <- list()
  
  for(i in 1:nrow(aoi)){
    nhd_waterbodies[[i]] <- nhdplusTools::get_waterbodies(AOI=aoi[i,])
  }
  
  nhd_waterbodies <- do.call('rbind',nhd_waterbodies) %>%
    sf::st_intersection(.,dplyr::select(aoi, UNIT_CODE))
  
  # return all nhd sf features
  obj <- list(nhd_flowlines, nhd_catchments, nhd_waterbodies)
  
  names(obj) <- c("flowlines", "catchments", "waterbodies")
  
  if(save == TRUE){
    sf::st_write(obj$flowlines, paste0(path,"_flowlines.shp"))
    sf::st_write(obj$catchments, paste(path,"_catchments.shp"))
    sf::st_write(obj$waterbodies, paste(path,"_waterbodies.shp"))
  }
  
  return(obj)
  
}