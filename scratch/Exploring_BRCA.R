
source("setup.R")

path <- "data/park/BRCA"

BRCA <- getParkBoundary("BRCA")

## Load in BRCA-specific data at the top:
springs_manual <- st_read('data/park/BRCA/manual/BRCA_springs_2022_survey_DRAFT/BRCA_Springs.shp') %>%
  st_transform(st_crs(BRCA))

# Buffer outside park
buffer <- BRCA %>%
  sf::st_buffer(., dist = 0.1)

watersheds <- getWatersheds(aoi = buffer, save = TRUE, path = path)

noaa_all <- getNOAA(aoi = buffer, park = "BRCA", startDate = "first", endDate = "2023-12-14")

annual_precip <- noaa_all %>%
  mutate(year = year(date)) %>%
  group_by(name, id, year) %>%
  summarize(prcp = sum(prcp, na.rm = TRUE))
#mapview(annual_precip) 

ggplot(annual_precip) +
  geom_point(aes(x = year, y = prcp, color = name)) +
  geom_smooth(aes(x = year, y = prcp), color = "black", method = "lm") +
  facet_wrap(~name, nrow = 5, scales = "free_y")

inventory <- inventoryNWIS(aoi = buffer, dist = 0)  %>%
  dplyr::mutate(site_type = ifelse(is.na(site_type), "Other", site_type)) %>%
  dplyr::filter(data_type != "Water Quality") %>%
  dplyr::filter(!is.na(code))

# download NWIS data:
getNWIS(inventory = inventory, park = "BRCA", path = 'data/park/', endDate = "2023-10-10", startDate = "1990-10-01")

wr <- getPODUtah(aoi = buffer, dist = 0) %>%
  dplyr::mutate(GPM = CFS * 448.8309375)

wu <- getWaterSuppliersUtah(aoi = buffer, dist = 0) 

water_use <- getWaterUseUtah(WRID = 1258)

visitation <- getVisitation(units = "BRCA", startYear = 1900, endYear = 2023) %>%
  mutate(MY = lubridate::ym(paste0(Year,"-",Month)))


months = tibble(Month = month.abb,
       Vals = 1:12)

well1 <- dplyr::slice(water_use[[1]],1:39)
names(well1) <- make.names(names(well1))
well1 <- well1 %>%
  pivot_longer(cols = -c("Year", "Annual.inAcre.Feet", "Method.of.Measurement")) %>%
  left_join(months, by = c("name" = "Month")) %>%
  mutate(MY = lubridate::ym(paste0(Year, "-", Vals)),
         value = ifelse(is.na(as.numeric(value)), 0, as.numeric(value)))


well2 <- dplyr::slice(water_use[[1]], 51:67)
names(well2) <- make.names(names(well2))
both_wells <- well2 %>%
  pivot_longer(cols = -c("Year", "Annual.inAcre.Feet", "Method.of.Measurement")) %>%
  left_join(months, by = c("name"="Month")) %>%
  mutate(MY = lubridate::ym(paste0(Year,"-",Vals)),
         value = ifelse(is.na(as.numeric(value)), 0, as.numeric(value))) %>%
  full_join(well1, by = "MY") %>%
  mutate(value.x = ifelse(is.na(as.numeric(value.x)), 0, as.numeric(value.x)),
         value.y = ifelse(is.na(as.numeric(value.y)), 0, as.numeric(value.y))) %>%
  mutate(value = as.numeric(value.x) + as.numeric(value.y))

visitation <- getVisitation(units = "BRCA", startYear = 1900, endYear = 2023) %>%
  mutate(MY = lubridate::ym(paste0(Year,"-",Month)))

visitors <- ggplot() +
  geom_line(data = visitation, aes(x=MY, y = RecreationVisitors + NonRecreationVisitors), color = "#002FA7")+
  geom_smooth(data = visitation, aes(x=MY, y = RecreationVisitors + NonRecreationVisitors), color = "black") +
  xlab("")+
  ylab("Total Visitors") +
  theme_bw()
# scale_y_continuous(
#   name = "Primary Y Axis",
#   sec.axis = sec_axis(~./50000, name = "Secondary Y Axis")
# )

use <- ggplot() +
  geom_line(data = both_wells, aes(x = MY, y = value), color = "#002FA7") +
  geom_smooth(data = both_wells, aes(x = MY, y = value), color = "black") +
  xlab("Time (by month)") +
  ylab("Total Water Use (acre-feet)") +
  theme_bw()

ggarrange(visitors, use, heights = c(4, 4), nrow = 2, align = "v")

per_person_use <- inner_join(both_wells, visitation, by = "MY") %>%
  mutate(TotalVisitors = as.numeric(RecreationVisitors) + as.numeric(NonRecreationVisitors)) %>% 
  select(MY, WaterUse = value, TotalVisitors) %>%
  mutate(UsePerVisitorGallons = (WaterUse*325851)/TotalVisitors)


ggplot() +
  geom_line(data = per_person_use, aes(x=MY, y=UsePerVisitorGallons)) +
  geom_smooth(data = per_person_use, aes(x=MY, y=UsePerVisitorGallons)) 
