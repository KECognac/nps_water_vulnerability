---
title: Explore the SSURGO dataset
format: HTML
editor: visual
---

```{r}
library(tidyverse)
library(sf)
library(tmap)
library(FedData) #functio to import SSURGO data

# set tmap to interactive
tmap_mode("view")
```

First load in a park shapefile to experiment with Bryce Canyon

```{r}
source("src/getParkBoundary.R")

brca <- getParkBoundary("BRCA")

qtm(brca)
```

Import SSURGO data (retrieves spatial and tabular soil attribute data) for BRCA

```{r}
brca_soil <- get_ssurgo(brca, label = "BRCA")
```

Note, BRCA is missing soil data for two of the three areas within park (aka all the areas within the park boundary)

```{r}
qtm(brca, fill = NULL, borders = "red") +
  qtm(brca_soil$spatial)
```

Investigate soil inventory:

```{r}
brca_invent <- get_ssurgo_inventory(brca)
```

UT636 and UT646 are incomplete as of 09-09-23. I do see data when downloading the gridded files for UTAH from here: <https://nrcs.app.box.com/v/soils/folder/180112652169>.

```{r}
# view layers in the geodatabase 
st_layers("data/gSSURGO_UT/gSSURGO_UT.gdb")  # need to read in layers individually
```

```{r}
# 'raster' layer doesn't work in R because of ESRI geodatabase (need to open in ArcPro)
soil_rast <- terra::rast("data/gSSURGO_UT/gSSURGO_UT.gdb", layer = "MapunitRaster_10m_UT_202301")
```

Work with vector data instead, see if there is info for the missing units:

```{r}
muaggat <- st_read("data/gSSURGO_UT/gSSURGO_UT.gdb", layer = "muaggatt")

names(muaggat)

mupolygon <- st_read("data/gSSURGO_UT/gSSURGO_UT.gdb", layer = "mupolygon")

missing <- mupolygon %>% filter(AREASYMBOL %in% c("UT636", "UT464"))

qtm(missing) +
  qtm(brca, fill = NULL, borders = "red")
```

Join with soil type data:

```{r}
find_missing <- left_join(missing, muaggat, by = join_by(MUKEY == mukey))
```

Looks like we can pull some info from these gridded datastets, even though the inventory states these units are incomplete.

Let's try Zion instead..

```{r}
zion <- getParkBoundary("ZION")

zion_soil <- get_ssurgo(zion, label = "ZION")
```

```{r}
qtm(zion, fill = NULL, borders = "red") +
  qtm(zion_soil$spatial)
```

```{r}
names(zion_soil$tabular)
```

Tabular metadata: <https://data.nal.usda.gov/system/files/SSURGO_Metadata_-_Table_Column_Descriptions.pdf>

Can join all to spatial data via 'mukey'

```{r}
zion_soil_sp <- zion_soil$spatial %>% 
  mutate(mukey = as.numeric(MUKEY))
```

Example, look at soil types:

```{r}
zion_muaggatt <- left_join(zion_soil_sp, zion_soil$tabular$muaggatt, by = "mukey")

zion_muaggatt %>% 
  st_drop_geometry() %>% 
  group_by(muname) %>% 
  count()

```

More geologic attributes:

```{r}
#hydrologic group
qtm(zion_muaggatt, fill = "hydgrpdcd")

# min bedrock depth
qtm(zion_muaggatt, fill = "brockdepmin")

# annual min water table depth
qtm(zion_muaggatt, fill = "wtdepannmin")
```
