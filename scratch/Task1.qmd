---
title: "Task 1: Hydrology, Climate, and Water Supply Data Inventory for Pilot Parks"
author: "Kathryn Willi (ROSSyndicate), Caitlin Mothes (Geospatial Centroid)"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(mapview)
library(lubridate)
library(sf)
try(plyr::ldply(list.files(path="src/",
                       pattern="*.R",
                       full.names=TRUE),
            source))

park <- c("DEVA","MOJA","JOTR")

dist <- 0.3

park_boundary <- getParkBoundary(park=park)

park_buffer <- park_boundary %>% 
    sf::st_buffer(., dist = dist)

#watershed <- getWatersheds(aoi = park_boundary, dist = 0)
d_watershed <- st_read('data/all/DEVA_group_watersheds.shp')# %>% group_by(UNIT_CODE) %>% summarize()
m_watershed <-st_read('data/all/MOJA_group_watersheds.shp')
j_watershed <-st_read('data/all/JOTR_group_watersheds.shp')
watershed <- rbind(d_watershed,m_watershed,j_watershed) %>% mutate(YAY="WATHERSHEDS") %>% dplyr::group_by(YAY) %>% dplyr::summarize()
split_ws <- rbind(d_watershed,m_watershed,j_watershed)


# flowlines <- hydro_network$flowlines %>%
#   filter(!is.na(gnis_name))
# watershed <- hydro_network$watersheds

aquifers <- downloadAquifers(aoi=park_boundary, dist = dist)

aoi <- sf::st_union(watershed, aquifers, park_buffer) %>%
  summarize()

aoi_split <- sf::st_union(watershed, aquifers, park_buffer)

mapview(aoi)
```

# WATER RIGHTS:: FIX YOU. NV AND CALIFORNIA ARE DIFFERENT DATA TYPES.

```{r}
# nv_water_rights <- getPODNevada(aoi=aoi, dist=0)  %>%
# mutate(POD_UNIT="ACRE FEET",
#        WR_WATER_RIGHT_ID = as.character(app)) %>%
# select(WR_WATER_RIGHT_ID, SOURCE_NAME=source_des, DIRECT_DIV_AMOUNT=diversio_1, POD_UNIT,POD_STATUS=app_status,
#        DIVERSION_TYPE=source, STORAGE_TYPE=mou, OWNER=owner_name, PARK_RIGHT) %>%
# mutate(STATE = "NV") %>%
#   saveRDS('data/all/nv_water_rights.RDS')
nv_water_rights <- readRDS('data/all/nv_water_rights.RDS')
# ca_water_rights <- geteWRIMS(aoi=aoi, dist=0) %>%
#   mutate(WR_WATER_RIGHT_ID=as.character(WR_WATER_RIGHT_ID))%>%
#   dplyr::select(WR_WATER_RIGHT_ID, SOURCE_NAME, DIRECT_DIV_AMOUNT, POD_UNIT, POD_STATUS,DIVERSION_TYPE, STORAGE_TYPE, OWNER=LAST_NAME, PARK_RIGHT=park_right) %>%
#   mutate(STATE = "CA") %>%
#   saveRDS('data/all/ca_water_rights.RDS')
ca_water_rights <- readRDS('data/all/ca_water_rights.RDS')
  
#both_wr <- sf::st_union(nv_water_rights,ca_water_rights) #%>%
#  st_write('data/all/ca_nv_rights.shp')

#both_wr <- st_read('data/all/ca_nv_rights.shp')

rights_ws_ca <- sf::st_intersection(ca_water_rights,watershed)
rights_aquifer_ca <- sf::st_intersection(ca_water_rights,aquifers)
rights_park_ca <- sf::st_intersection(ca_water_rights,park_buffer)

rights_ws_nv <- sf::st_intersection(nv_water_rights,watershed)
rights_aquifer_nv <- sf::st_intersection(nv_water_rights,aquifers)
rights_park_nv <- sf::st_intersection(nv_water_rights,park_buffer)

# ggplot() +
#   theme_void() +
#   geom_sf(data = aquifers, color = NA, aes(fill = OBJECTID_1), alpha = 0.75) +
#   geom_sf(data = watershed, color = "#abddde", fill = "#abddde", alpha=0.2) +
#   #scale_fill_manual(values = wesanderson::wes_palette("Zissou1", n = 4))+
#   geom_sf(data = ca_water_rights, alpha = 0.75, size=1.5, aes(shape = PARK_RIGHT)) +
#   geom_sf(data = park_boundary, fill = NA, color="black", size=0.1) +
#   scale_fill_gradientn(colours = pal_aq) +
#   theme(legend.position="none",
#         plot.title=element_text(hjust=0, vjust=0)) +
#   guides(fill=FALSE, color=FALSE) +
#   ggtitle("Water Right Points-of-Diversion")

pal_ws <- wesanderson::wes_palette("FantasticFox1", 50, type = "continuous")
pal_aq <- wesanderson::wes_palette("Zissou1", 29, type = "continuous")

watershed_map <- ggplot() +
  theme_void() +
  geom_sf(data = aquifers, color = NA, fill = NA, alpha = 0.75) +
  geom_sf(data = watershed, color = NA, fill = "#abddde", alpha = 0.3) +
  geom_sf(data = rights_ws_nv, color = 'black', fill = NA, alpha = 1, aes(shape = PARK_RIGHT)) +
  geom_sf(data = rights_ws_ca, color = 'black', fill = NA, alpha = 1, aes(shape = PARK_RIGHT)) +
  scale_fill_gradientn(colours = pal_ws) +
  geom_sf(data = park_boundary, fill = NA, color="black", size=1) +
  theme(legend.position="none",
        plot.title=element_text(hjust=0, vjust= 0)) +
  guides(fill=FALSE, color=FALSE) +
  ggtitle("Watersheds")


aquifer_map <- ggplot() +
  theme_void() +
  geom_sf(data = aquifers, color = NA, aes(fill = OBJECTID_1), alpha = 0.75) +
  geom_sf(data = watershed, color = NA, fill = NA) +
  #scale_fill_manual(values = wesanderson::wes_palette("Zissou1", n = 4))+
  geom_sf(data = rights_aquifer_ca, color = 'black', fill = NA, alpha = 1, aes(shape = PARK_RIGHT)) +
    geom_sf(data = rights_aquifer_nv, color = 'black', fill = NA, alpha = 1, aes(shape = PARK_RIGHT)) +
  geom_sf(data = park_boundary, fill = NA, color="black", size=1) +
  scale_fill_gradientn(colours = pal_aq) +
  theme(legend.position="none",
        plot.title=element_text(hjust=0, vjust=0)) +
  guides(fill=FALSE, color=FALSE) +
  ggtitle("Aquifers")

park_map <- ggplot() +
  theme_void() +
  geom_sf(data=aquifers, color=NA, fill=NA, alpha=0.75) +
  #scale_fill_manual(values = wesanderson::wes_palette("Zissou1", n = 4))+
  geom_sf(data=watershed, color=NA, fill=NA) +
  geom_sf(data=park_buffer, fill = "#74a089", color=NA, size=NA, alpha=0.3) +
  geom_sf(data=park_boundary, fill = "#74a089", color="black", size=1) +
  geom_sf(data = rights_park_ca, color = 'black', fill=NA, alpha=1, aes(shape = PARK_RIGHT)) +
  geom_sf(data = rights_park_nv, color = 'black', fill=NA, alpha=1, aes(shape = PARK_RIGHT)) +
  ggspatial::annotation_scale(location = "bl", width_hint = 0.5) +
  ggspatial::annotation_north_arrow(location = "bl", which_north = "true",
                                    pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                                    style = ggspatial::north_arrow_fancy_orienteering) +
  theme(legend.position="none",
        plot.title=element_text(hjust=0, vjust= 0)) +
   guides(fill=FALSE, color=FALSE) +
  labs(shape="Site Type") +
  ggtitle("Park Boundary")


ggpubr::ggarrange(park_map, watershed_map, aquifer_map, nrow=1, common.legend=TRUE, legend="right")
```

# NWIS Flow Locations

Sites with flow data recorded since 2015 within our areas of interest.

```{r}
# nwis_all <- pullNWIS(aoi = aoi, dist = 0) %>%
#   mutate(threshold = ifelse(lubridate::year(end_date) >= (lubridate::year(Sys.Date())-5), "Current", "Old")) %>%
#   mutate(parameter_type = paste0(parameter, " (", data_type, ", ", site_type, ")"),
#          date_range = ifelse(lubridate::year(begin_date) == lubridate::year(end_date), lubridate::year(end_date), paste0(lubridate::year(begin_date), "-", lubridate::year(end_date)))) %>%
#   filter(threshold == "Current") %>%
# mutate(flow_data = ifelse(grepl("discharge|flow|height|level|width", parameter_type,ignore.case=T) &! grepl("sediment",parameter_type,ignore.case=T), "Flow", "Other")) %>%
#   mutate(site_type=case_when(site_type_cd == "AT" ~ "Weather Station",
#                    grepl("GW|GW-", site_type_cd) ~ "Groundwater",
#                    site_type_cd %in% c("SP") ~ "Spring",
#                    site_type_cd %in% c("ST","ST-TS") ~ "Stream",
#                    site_type_cd %in% c("SB-CV") ~ "Cave",
#                    site_type_cd %in% c("ST-CA","ST-DCH") ~ "Canal/Ditch",
#                    site_type_cd == "ES" ~ "Estuary",
#                    site_type_cd == "LK" ~ "Lake",
#                    site_type_cd %in% c("SB") ~ "Subsurface",
#                    site_type_cd == "SB-GWD" ~ "Ground-water Drain",
#                    site_type_cd == "SB-TSM" ~ "Shaft/Tunnel",
#                    site_type_cd == "SB-GWD" ~ "Ground-water Drain",
#                    site_type_cd == "SB-UZ" ~ "Unsaturated Zone")) %>%
#   st_write('data/all/nwis_sites.shp')
# nwis_sites <-st_read('data/all/nwis_sites.shp') %>%
#   select(site_no, site_name, stie_type, parameter_type, date_range, n_obs, threshold, flow_data) 

###

# nwis_park <- pullNWIS(aoi = park_boundary, dist = dist) %>%
#   mutate(threshold = ifelse(lubridate::year(end_date) >= (lubridate::year(Sys.Date())-5), "Current", "Old")) %>%
#   mutate(parameter_type = paste0(parameter, " (", data_type, ", ", site_type, ")"),
#          date_range = ifelse(lubridate::year(begin_date) == lubridate::year(end_date), lubridate::year(end_date), paste0(lubridate::year(begin_date), "-", lubridate::year(end_date)))) %>%
#   filter(threshold == "Current") %>%
# mutate(flow_data = ifelse(grepl("discharge|flow|height|level|width", parameter_type,ignore.case=T) &! grepl("sediment",parameter_type,ignore.case=T), "Flow", "Other")) %>%
#   mutate(site_type=case_when(site_type_cd == "AT" ~ "Weather Station",
#                    site_type_cd %in% c("GW", "GW-TH") ~ "Groundwater",
#                    site_type_cd %in% c("SP") ~ "Spring",
#                    site_type_cd %in% c("ST") ~ "Stream",
#                    site_type_cd %in% c("SB-CV") ~ "Cave"))
# #select(site_no, site_name, parameter_type, date_range, n_obs, threshold, flow_data)
# 
# nwis_watershed <- pullNWIS(aoi = dplyr::summarize(watershed), dist = 0) %>%
#   mutate(threshold = ifelse(lubridate::year(end_date) >= (lubridate::year(Sys.Date())-5), "Current", "Old")) %>%
#   mutate(parameter_type = paste0(parameter, " (", data_type, ", ", site_type, ")"),
#          date_range = ifelse(lubridate::year(begin_date) == lubridate::year(end_date), lubridate::year(end_date), paste0(lubridate::year(begin_date), "-", lubridate::year(end_date)))) %>%
#   filter(threshold == "Current") %>%
# mutate(flow_data = ifelse(grepl("discharge|flow|height|level|width", parameter_type,ignore.case=T) &! grepl("sediment",parameter_type,ignore.case=T), "Flow", "Other")) %>%
#   mutate(site_type=case_when(site_type_cd == "AT" ~ "Weather Station",
#                    site_type_cd %in% c("GW", "GW-TH") ~ "Groundwater",
#                    site_type_cd %in% c("SP") ~ "Spring",
#                    site_type_cd %in% c("ST") ~ "Stream",
#                    site_type_cd %in% c("SB-CV") ~ "Cave")) %>%
#   st_write('data/all/nwis_waterhed.shp')
# 
# nwis_aquifer <- pullNWIS(aoi = dplyr::summarize(aquifers), dist = 0) %>%
#     mutate(threshold = ifelse(lubridate::year(end_date) >= (lubridate::year(Sys.Date())-5), "Current", "Old")) %>%
#   mutate(parameter_type = paste0(parameter, " (", data_type, ", ", site_type, ")"),
#          date_range = ifelse(lubridate::year(begin_date) == lubridate::year(end_date), lubridate::year(end_date), paste0(lubridate::year(begin_date), "-", lubridate::year(end_date)))) %>%
#   filter(threshold == "Current") %>%
# mutate(flow_data = ifelse(grepl("discharge|flow|height|level|width", parameter_type,ignore.case=T) &! grepl("sediment",parameter_type,ignore.case=T), "Flow", "Other")) %>%
#   mutate(site_type=case_when(site_type_cd == "AT" ~ "Weather Station",
#                    site_type_cd %in% c("GW", "GW-TH") ~ "Groundwater",
#                    site_type_cd %in% c("SP") ~ "Spring",
#                    site_type_cd %in% c("ST") ~ "Stream",
#                    site_type_cd %in% c("SB-CV") ~ "Cave")) %>%
#   st_write('data/all/nwis_aquifer.shp')

# nwis_all <- nwis_park %>%
#   bind_rows(nwis_aquifer) %>%
#   distinct(.,.keep_all=TRUE)
#   bind_rows(nwis_watershed) %>%
#   distinct(.,.keep_all=TRUE) %>%
#   saveRDS(.,'data/all/nwis_all.RDS')
nwis_all <- readRDS('data/all/nwis_all.RDS') %>%
  mutate(site_type=ifelse(is.na(site_type),"Other",site_type)) %>%
  filter(flow_data=="Flow") %>%
  st_join(select(aoi_split,UNIT_CODE),left=TRUE) %>%
  distinct(.,.keep_all=TRUE)
#####

pal_nwis <- wesanderson::wes_palette("FantasticFox1", 4, type = "continuous")
mapviewOptions(basemaps.color.shuffle=FALSE,basemaps=c('CartoDB.Positron', 'CartoDB.DarkMatter', 'OpenStreetMap', 'Esri.WorldImagery', 'OpenTopoMap'))

# mapview::mapview(park_boundary, col.regions="black", alpha.regions=0, lwd=2, popup=FALSE, legend=F, homebutton=FALSE,label=FALSE) +
#    mapview(watershed, col.regions = "#abddde",legend=F, homebutton=FALSE, popup=FALSE) +
#   mapview::mapview(aquifers, col.regions = pal_aq, zcol='OBJECTID_1', popup=FALSE, legend=F, lwd =1, alpha.regions=0.5, homebutton=FALSE, label=FALSE) +
  mapview(nwis_all, col.regions =pal_nwis, zcol = 'site_type', alpha.regions=1, alpha=1, cex=4, layer.name="NWIS Flow Sites") +
mapview(aoi,col.regions="black", alpha.regions=0, lwd=2, popup=FALSE, legend=F, homebutton=FALSE,label=FALSE) +
  mapview(park_boundary, col.regions="#74a089", alpha.regions=0.33, lwd=2, popup=FALSE, legend=F, homebutton=FALSE,label=FALSE)
  
    #select(site_no,site_name,parameter_type,date_range,n_obs,within_park,threshold,flow_data)
    
nwis_all %>%
  filter(flow_data=="Flow",
         threshold=="Current") %>%
    select(UNIT_CODE,site_no,site_name,parameter_type,date_range,n_obs,threshold,flow_data, site_type) %>%
  sf::st_drop_geometry() %>%
  arrange(desc(site_name)) %>%
  kableExtra::kable('html') %>%
  kableExtra::kable_styling(position='center') %>%
  kableExtra::scroll_box(width='900px',height='500px')
    
```

\

```{r}
recharge <- downloadRecharge(aoi = aoi, dist = 0)

pal_recharge <- wesanderson::wes_palette("Zissou1", 150, type = "continuous")

mapview(recharge[[1]], col.regions = pal_recharge, layer.name= "Monthly Groundwater Recharge Index") + 

mapview::mapview(park_boundary, col.regions="black", alpha.regions=0, lwd=2, popup=FALSE, legend=F, homebutton=FALSE,label=FALSE) +
  mapview::mapview(aquifers, col.regions = "black", popup=FALSE, legend=F, lwd =1, alpha.regions=0, homebutton=FALSE, label=FALSE)
```

```{r}
visitor_stats <- getVisitation(type='park', startYear = 1900, endYear = 2022, units = park )
```

# Aquarius

```{r}
#aquarius <- downloadAquarius(park="DEVA") 
aquarius <- read_csv('data/quarto/aquarius.csv')

aquarius_inventory <- aquarius %>%
  mutate(timestamp = ymd_hms(timestamp),
         year = year(timestamp)) %>%
  group_by(siteID, Location.Type, parameter, Long, Lat, EPSG) %>%
  summarize(n_obs = n(),
            threshold = ifelse(max(year) >= (lubridate::year(Sys.Date())-5), "Current", "Old"),
            range = ifelse(min(year) == max(year), paste0(min(year)), paste0(min(year), "-", max(year)))) %>%
  mutate(flow_data=ifelse(grepl("velocity|WaterPressure|discharge|flow|height|level|stage|depthtowater",parameter,ignore.case=T)&!grepl("sediment",parameter,ignore.case=T), "Flow", "Other")) %>%
  sf::st_as_sf(coords=c("Lat","Long"), crs=4326)
```

There are `r aquarius_inventory %>% as_tibble() %>%  dplyr::filter(threshold == "Current") %>% distinct(siteID, .keep_all = FALSE) %>% n_distinct()` Aquarius monitoring locations that have collected data since `r lubridate::year(Sys.Date())-5` within `r park` 's park boundary. `r as.numeric(aquarius_inventory %>% as_tibble() %>% filter(threshold=="Current" & flow_data=="Flow") %>% distinct(siteID,.keep_all=F) %>% n_distinct())` of those sites monitor flow-related parameters.

```{r}
mapview(filter(aquarius_inventory, threshold == "Current"), zcol='flow_data', layer.name = 'Current Data') + 
  mapview(filter(aquarius_inventory, threshold == "Old"), zcol='flow_data', cex=3, alpha = 1, layer.name = 'Older Aquarius Locations') +
  mapview(aoi,col.regions="#009E73",alpha = 1, legend = F)

```

```{r}
aquarius_inventory %>%
  filter(flow_data=="Flow",
         threshold=="Current") %>%
  sf::st_drop_geometry() %>%
  arrange(desc(siteID)) %>%
  kableExtra::kable('html') %>%
  kableExtra::kable_styling(position='center') %>%
  kableExtra::scroll_box(width='900px',height='500px')
```

# WQP

```{r}
sites <- downloadWQPSites(aoi,dist)

data <- downloadWQPData(sites=sites) %>%
  rename(SiteID=MonitoringLocationIdentifier,
         date=ActivityStartDate,
         time=ActivityStartTime.Time,
         parameter=CharacteristicName,
         org=OrganizationFormalName,
         org_id=OrganizationIdentifier,
         value=ResultMeasureValue,
         original_units=ResultMeasure.MeasureUnitCode,
         sample_method=SampleCollectionMethod.MethodName,
         analytical_method=ResultAnalyticalMethod.MethodName,
         particle_size=ResultParticleSizeBasisText,
         media=ActivityMediaName,
         type=ActivityMediaSubdivisionName,
         sample_depth=ActivityDepthHeightMeasure.MeasureValue,
         sample_depth_unit=ActivityDepthHeightMeasure.MeasureUnitCode,
         fraction=ResultSampleFractionText,
         status=ResultStatusIdentifier)
```

We were unable to access several relevant data sets:

-   NPS geospatial layer representing [all buildings within park units](https://mapservices.nps.gov/arcgis/rest/services/NationalDatasets). The layer appears to be broken. We intend to use this geospatial layer to identify locations that water is sent to, in an attempt to make a first pass at where NPS water rights go, and where water rights might be leased.

-   Worklow linked to customizing outputs for the [*What water balance product do you need?*](https://screenedcleanedsummaries.s3.us-west-2.amazonaws.com/which_water_balance.html)dataset*.* This requires NPS VPN access. Currently, we are just pulling the pre-existing datasets, and clipping their geometries to the areas of interest.

-   [Projections of freshwater use in the United States under climate change](https://www.fs.usda.gov/research/treesearch/63896). We are unable to find the public dataset, but we have reached out to the primary author for access.
