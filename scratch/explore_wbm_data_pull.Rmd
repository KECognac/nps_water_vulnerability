---
title: "Explore WBM Data Pull"
author: "Caitlin Mothes, PhD"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("setup.R")

# load in report data to get BRCA supply and boundary to test pulling
load("data/park/BRCA/BRCA_report_data.RData")

# get singl water supply point to test with
test_point <- POD_supply[1,]

# need to increase timeout option for downloading large daily files
options(timeout=10000)
```


## Explore Pulling Future WBM (edits to `getFutureWBM.R`)


### Create new function to pull future WBM data
```{r}
get_future_wbm <- function(park, aoi, years, macas, wb_var, path = "data/park/") {
  
  # create temp directory
  if (!dir.exists(paste0(getwd(), "/temp/"))) {
    dir.create(file.path(getwd(), "/temp/"), showWarnings = FALSE)
  }
  
  # check that path to save files to exists
  if (!dir.exists(paste0(getwd(), "/", path, "/", park, "/wbm/"))) {
    dir.create(file.path(paste0(getwd(), "/", path, "/", park, "/wbm/")), showWarnings = FALSE)
  }
  
  # create df of all variable, year, scenario combinations
  map_dat <- tidyr::crossing(years, wb_vars, macas) %>%
    tidyr::separate_wider_delim(macas, delim = ".", names = c("maca", "rcp"))
  
  # download each raster file to temp directory
  walk(1:nrow(map_dat), function(x) {
    call <- paste0(
      "http://www.yellowstone.solutions/thredds/fileServer/daily_or_monthly/gcm/",
      map_dat$rcp[x],
      "/",
      map_dat$maca[x],
      "/V_1_5_",
      map_dat$years[x],
      "_",
      map_dat$maca[x],
      "_",
      map_dat$rcp[x],
      "_",
      map_dat$wb_vars[x],
      ".nc4"
    )
    
    download.file(
      call,
      destfile = paste0(
        "templeod_dataall/",
        map_dat$wb_vars[x],
        "_",
        map_dat$years[x],
        "_",
        map_dat$maca[x],
        "_",
        map_dat$rcp[x],
        "_data.nc4"
      )
    )
    
  })
  
  # list all downloaded files
  files <- list.files(path = "templeod_dataall/",
                      pattern = ".nc4",
                      full.names = TRUE)
  
  # read in all rasters
  rasters <- terra::rast(files)
  
  # create a cleaned raster stack with appropriate layer names and keep units
  
  ## need to split layers to assign correct source name
  rasters_split <- terra::split(rasters, 1:nlyr(rasters))
  
  ## assign each layer its full name
  rasters_split_named <- map(1:length(rasters_split),
                             ~ set_names(rasters_split[[.x]], paste0(
                               names(rasters_split[[.x]]),
                               "_",
                               str_extract(basename(sources(rasters_split[[.x]])), "[^data]+")
                             )))
  
  ## combine all to single stack
  final_stack <- terra::rast(rasters_split_named)
  
  
  # crop all rasters to aoi
  stack_crop <- terra::crop(final_stack, st_transform(aoi, crs = crs(final_stack)))
  
  # save final raster stack to file
  terra::writeRaster(
    stack_crop,
    filename = paste0(
      getwd(),
      "/",
      path,
      "/",
      park,
      "/wbm/",
      park,
      "_",
      wb_var,
      "_",
      macas[1],
      "_",
      macas[2],
      "_",
      years[1],
      "_",
      years[2],
      ".tif"
    ),
    overwrite = TRUE
  )
  
  # delete temp directory
  unlink("templeod_dataall/", recursive = TRUE)
  
}
```


### Run function

Set up to do one variable at a time
Throwing error trying to download file at index #6
```{r}
start <- Sys.time()

walk(c("soil_water", "runoff", "rain", "accumswe", "PET", "Deficit", "AET"), ~get_future_wbm(park = park, aoi = st_buffer(park_boundary, 20000), years = 2023:2099, wb_var = .x, macas = select_cfs$GCM))

end <- Sys.time()

end - start
```

