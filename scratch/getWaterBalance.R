#' Import and mask water balance model data
#' 
#' 
#' @param aoi An sf polygon object, often a park boundary (or boundaries) retrieved from `getParkBoundary()`.
#' @param season The season data will be downloaded for. Can be "annual" (default), "winter", "spring", "summer", or "fall".
#' @param path If `save = TRUE`, the file path to save the shapefile
#' 
#' @return A Water Balance rasters masked to each specified area of interest
getWaterBalance <- function(aoi, season = "annual"){
  
  if(!dir.exists(paste0(getwd(),"/data/all/wb_models/"))){dir.create(file.path(getwd(),"/data/all/wb_models/"), showWarnings = FALSE)}
  
  if(!dir.exists(paste0(getwd(),"/data/all/wb_models/accumswe")) & !dir.exists(paste0(getwd(),"/data/all/wb_models/rain")) &
     !dir.exists(paste0(getwd(),"/data/all/wb_models/runoff")) & !dir.exists(paste0(getwd(),"/data/all/wb_models/soil_water"))&
     !dir.exists(paste0(getwd(),"/data/all/wb_models/Deficit")) & !dir.exists(paste0(getwd(),"/data/all/wb_models/PET")) &
     !dir.exists(paste0(getwd(),"/data/all/wb_models/AET"))){
    
    sf::sf_use_s2(FALSE)
    
    # All Datasets:
    wb <- c("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain.zip",
            "http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff.zip",
            "http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe.zip",
            "http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water.zip",
            "http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit.zip",
            "http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET.zip",
            "http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET.zip")
    
    
    # AET
    # historical_wb <- c(paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_1980_2019_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_2000_2019_", season, "_means_cropped_units_mm.tif"),
    #                    # Deficit
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_1980_2019_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_2000_2019_", season, "_means_cropped_units_mm.tif"),
    #                    # PET
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_1980_2019_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_2000_2019_", season, "_means_cropped_units_mm.tif"),
    #                    # Rain
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    #paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_1980_2019_", season, "_means_cropped_units_mm.tif")
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_2000_2019_", season, "_means_cropped_units_mm.tif"),
    #                    # Accumulated SWE
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_1980_2019_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_2000_2019_", season, "_means_cropped_units_mm.tif"),
    #                    # Runoff
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_1980_2019_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_2000_2019_", season, "_means_cropped_units_mm.tif"),
    #                    # Soil Water
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_1980_1999_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_1980_2019_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_1981_2010_", season, "_means_cropped_units_mm.tif"),
    #                    paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_2000_2019_", season, "_means_cropped_units_mm.tif"))
    
    for(i in 1:length(wb)){
      # download datasets 
      
      temp1 <- tempfile()
      
      download.file(paste0(wb[i]), destfile = temp1, method = "curl")
      
      unzip(temp1, exdir = "data/all/wb_models/")
    }
    
  }
  
  
  all_files <- list.files('data/all/wb_models/', pattern = "*.tif", 
                          full.names = TRUE, recursive = TRUE)
  
  wb_masker <- function(files){
    
    for(i in 1:nrow(aoi)){
      
      ras <- terra::rast(files)
        
      aoi_bb <- st_transform(aoi[i,], st_crs(ras))
      
      if(!dir.exists(paste0(getwd(),"/data/park/",aoi_bb$UNIT_CODE, "/waterbalance/"))){dir.create(paste0(getwd(),"/data/park/",aoi_bb$UNIT_CODE, "/waterbalance/"), showWarnings = FALSE)}
  
      
      cropped <- terra::crop(ras, aoi_bb, mask = TRUE) #%>%
      #tmap::qtm(cropped)
      terra::writeRaster(cropped, 
                         paste0("data/park/", aoi_bb$UNIT_CODE, "/waterbalance/",
                                str_replace_all(str_sub(files, 21, nchar(files)), "/", "_")),
                                overwrite = TRUE)
    
    }
    
  }
  
  walk(all_files, ~wb_masker(.))
  
}