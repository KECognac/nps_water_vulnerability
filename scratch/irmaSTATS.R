# test getting IRMA park visitation statistics

library(httr)
library(jsonlite)
library(dplyr)
library(purrr)
library(readr)
library(ggplot2)


#base URL call
call <- "https://irmaservices.nps.gov/v3/rest/stats"


#get stats for all parks for a single year -----------------------------------
stats2020 <- httr::GET(paste0(call, "/total/", "2020"))


#view content structure of returned call
str(content(stats2020))
#nested list for each variable (6 total) for each month (12 total)

# convert content to text
stats2020_text <- content(stats2020, "text", encoding = "UTF-8")

#parse data in JSON
stats2020_json <- fromJSON(stats2020_text, flatten = TRUE)

#convert items to data.frame
stats2020_df <- as_tibble(stats2020_json)

#quick plot out of interest
stats2020_df %>% 
  mutate(Month = as.factor(Month)) %>% 
ggplot(aes(x = Month, y = RecreationVisitors, group = 1)) +
  geom_line() +
  geom_point()


#get stats for specific park and date range ----------------
## as of 11/3 the portal was down...
units <- "DEVA,JOTR"
startMonth <- 1
startYear <- 2018
endMonth <- 12
endYear <- 2020

deva <- httr::GET(paste0(call, "/visitation?unitCodes=", units, "&startMonth=",
                         startMonth, "&startYear=", startYear, "&endMonth=",
                         endMonth, "&endYear=", endYear, ""))



#view content structure of returned call
str(content(deva))
#nested list for each variable (6 total) for each month (12 total)

# convert content to text
deva_text <- content(deva, "text", encoding = "UTF-8")

#parse data in JSON
deva_json <- fromJSON(deva_text, flatten = TRUE)

#convert items to data.frame
deva_df <- as_tibble(deva_json)



