library(tidyverse)

plyr::ldply(list.files(path="src/",
                       pattern="*.R",
                       full.names=TRUE),
            source)

park <- getParkBoundary(c("DEVA","JOTR","MOJA"))
dist=0.2


## PULLING ALL AVAILABLE FLOW DATA IN NWIS ##

# DOWLOADING ALL DATA
pullFlowUSGS(park, dist) %>%
  sf::st_write(., 'data/nwis/nwis_flow_inventory.shp')

inventory <- sf::st_read('data/nwis/nwis_flow_inventory.shp') %>%
  dplyr::mutate(combo=paste0(site_no,"-",code))

# DAILY

daily <- inventory %>%
  dplyr::filter(dt_typ_=="dv")

list <- unique(daily$combo)

nwis_puller <- function(list){

  ind <- dplyr::filter(daily, combo==list)

  dataRetrieval::readNWISdv(unique(ind$site_no), unique(ind$code),
             startDate="", endDate="") %>%
    write.csv(
      paste0('data/nwis/dv/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

map(list,
    possibly(nwis_puller, otherwise=1+1))

nwis_dv <- plyr::ldply(list.files(path="data/nwis/dv/",
                                  pattern="*.csv",
                                  full.names=TRUE),
                       read_csv)

# UNIT

uv <- inventory %>%
  dplyr::filter(dt_typ_ == "uv") %>%
  # remove sites that already have daily data available for the given 
  # parameter, site, and date range
  dplyr::filter(!combo %in% daily$combo) %>% 
  distinct(combo,.keep_all=TRUE)

list <- unique(uv$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(uv, combo==list)
  
  dataRetrieval::readNWISuv(unique(ind$site_no), unique(ind$code),
                            startDate="", endDate="") %>%
    write.csv(
      paste0('data/nwis/uv/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

map(list,
    possibly(nwis_puller, otherwise=1+1))

nwis_uv <- plyr::ldply(list.files(path="data/nwis/uv/",
                                  pattern="*.csv",
                                  full.names=TRUE),
                       read_csv)

# GROUNDWATER

gwl <- inventory %>%
  dplyr::filter(dt_typ_ == "gw") %>%
  # remove sites that already have daily data available for the given 
  # parameter, site, and date range
  dplyr::filter(!combo %in% daily$combo) %>%
  distinct(combo,.keep_all=TRUE)

list <- unique(gwl$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(gwl, combo==list)
  
  dataRetrieval::readNWISgwl(unique(ind$site_no), unique(ind$code),
                            startDate="", endDate="") %>%
    write.csv(
      paste0('data/nwis/gwl/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

map(list,
    possibly(nwis_puller, otherwise=1+1))

nwis_gwl <- plyr::ldply(list.files(path="data/nwis/gwl/",
                                  pattern="*.csv",
                                  full.names=TRUE),
                       read_csv)



############## AQUARIUS HTML FUN #####################

parameters <- c("Absolute Pressure",
                'Depth',
                'Depth to Ground Surface From Top of Casing', 'DepthToGroundFromCasingTop',
                'Depth to Water From Ground Surface', 'DepthToWaterFromGround',
                "Depth to Water From Measuring Point", "DepthToWaterFromMeasuringPoint",
                "Depth to Water From Top of Casing", "DepthToWaterFromCasingTop",
                "Discharge",
                "Discharge cumulative volume increment", "Discharge Total",
                "Discharge velocity", "Discharge Velocity",
                "Gage Height at Zero Flow", "GZF",
                "Groundwater Elevation", "GroundwaterElevation",
                "Height of Gauge (River Stage)", "Stage",
                "Lake Depth",
                "River Cross Section Area", "River X Area", "River XArea",
                "River Cross Section Width", "River X Width",
                "Water Level",
                "Water Level Elevation (MSL)",
                "Water Level in  NAVD88", "WaterLevelNAVD88",
                "Water Pressure - Vented", "WaterPressureVented",
                "Water Pressure Depth", "DepthFromWaterPressure",
                "Water Velocity", "Sensor Velocity",
                "Water, velocity", "Water Velocity")



## NHD/STREAMCAT STUFF##

mutate(site_pretty=paste0("USGS-",site_no))
nwis_list <- nwis$site_pretty

nwis$comid <- NA #attempt 'get_nldi_feature' first
nwis$comid_coords <- NA #if that doesn't work for all gages (not sure why this is happening?), do 'discover_nhdplus_id()'

#first try to get comid using nldi (verified correct comid)
for(i in 1:length(nwis_list)){
  try(nwis$comid[i] <- get_nldi_feature(list("featureSource" = "nwissite", featureID = nwis_list[i]))$comid, silent=T)
}

#ones it didn't work for (n=_____). Perhaps these are new gages?
weirdos <- nwis %>% filter(is.na(comid))

#get the comid using the weirdos' coordinates instead of their gage name
for(i in 1:nrow(nwis)){
  nwis$comid_coords[i] <- discover_nhdplus_id(nwis[i,])
}

nwis <- nwis %>%
  mutate(comid=ifelse(is.na(comid), comid_coords, comid)) %>%
  mutate(comid=as.numeric(comid))

# Water rights
water_rights <- geteWRIMS(park,dist) %>%
  filter(POD_STATUS=="Active") %>%
  mutate(comid=NA)

for(i in 1:nrow(water_rights)){
  water_rights$comid[i] <- discover_nhdplus_id(water_rights[i,])
}

# function that, for every water right POD, finds USGS gages within 20 km up- or downstream.
gages_within_10km <- function(spid_union){
  
  tracer <- function(samples){
    
    gages <- as_tibble(nwis) %>% mutate(comid=as.numeric(comid)) %>% left_join(nhd, by="comid")
    
    outlet <-as_tibble(water_rights) %>%
      dplyr::filter(POD_ID == samples) %>%
      dplyr::left_join(nhd,by="comid")
    
    upstream_nhd <- get_UT(nhd, outlet$comid, distance= 20 + outlet$lengthkm) %>% # upstream trace function in nhdplusTools package
      as_tibble() %>%
      rename(comid = value)
    
    downstream_nhd <- get_DM(nhd, outlet$comid, distance =20 + outlet$lengthkm) %>%
      as_tibble() %>%
      rename (comid = value)
    
    rbind(upstream_nhd,downstream_nhd) %>%
      distinct(comid,.keep_all=TRUE) %>%
      inner_join(.,nwis,by='comid') %>%
      select(site_no,site_name)
    
  }
  
  scat <- map_dfr(spid_union, tracer)
}

nearby_gages <- water_rights %>%
  mutate(gages = map(POD_ID, gages_within_10km))

# Now we have a list of all gages within 20 km of every water right

full_list <- unnest(nearby_gages,cols=gages) #%>% select(SampleName,COMID,gage) %>%
  inner_join(as_tibble(nwis),by='site_no')
  