library(tidyverse)

plyr::ldply(list.files(path="src/",
                       pattern="*.R",
                       full.names=TRUE),
            source)

park <- c("DEVA","JOTR","MOJA")
aoi <- getParkBoundary(park=park)
dist <- 0.2

## NHD STUFF FOR SURFACE WATER RIGHTS##


mutate(site_pretty=paste0("USGS-",site_no)) %>%
  filter(type!="Groundwater") # or whatever equivalent field

nwis_list <- nwis$site_pretty

nwis$comid <- NA #attempt 'get_nldi_feature' first
nwis$comid_coords <- NA #if that doesn't work for all gages (not sure why this is happening?), do 'discover_nhdplus_id()'

#first try to get comid using nldi (verified correct comid)
for(i in 1:length(nwis_list)){
  try(nwis$comid[i] <- get_nldi_feature(list("featureSource" = "nwissite", featureID = nwis_list[i]))$comid, silent=T)
}

#ones it didn't work for (n=_____). Perhaps these are new gages?
weirdos <- nwis %>% filter(is.na(comid))

#get the comid using the weirdos' coordinates instead of their gage name
for(i in 1:nrow(nwis)){
  nwis$comid_coords[i] <- discover_nhdplus_id(nwis[i,])
}

nwis <- nwis %>%
  mutate(comid=ifelse(is.na(comid), comid_coords, comid)) %>%
  mutate(comid=as.numeric(comid))

# Water rights
water_rights <- geteWRIMS(park,dist) %>%
  filter(POD_STATUS=="Active") %>%
  filter(POD_Type != Groundwater) %>% #or whatever equivalent
  mutate(comid=NA)

for(i in 1:nrow(water_rights)){
  water_rights$comid[i] <- discover_nhdplus_id(water_rights[i,])
}

# function that, for every water right POD, finds USGS gages within 20 km up- or downstream.
gages_within_10km <- function(spid_union){
  
  tracer <- function(samples){
    
    gages <- as_tibble(nwis) %>% mutate(comid=as.numeric(comid)) %>% left_join(nhd, by="comid")
    
    outlet <-as_tibble(water_rights) %>%
      dplyr::filter(POD_ID == samples) %>%
      dplyr::left_join(nhd,by="comid")
    
    upstream_nhd <- get_UT(nhd, outlet$comid, distance= 20 + outlet$lengthkm) %>% # upstream trace function in nhdplusTools package
      as_tibble() %>%
      rename(comid = value)
    
    downstream_nhd <- get_DM(nhd, outlet$comid, distance =20 + outlet$lengthkm) %>%
      as_tibble() %>%
      rename (comid = value)
    
    rbind(upstream_nhd,downstream_nhd) %>%
      distinct(comid,.keep_all=TRUE) %>%
      inner_join(.,nwis,by='comid') %>%
      select(site_no,site_name)
    
  }
  
  scat <- map_dfr(spid_union, tracer)
}

nearby_gages <- water_rights %>%
  mutate(gages = map(POD_ID, gages_within_10km))

# Now we have a list of all gages within 20 km of every water right

full_list <- unnest(nearby_gages,cols=gages) #%>% select(SampleName,COMID,gage) %>%
inner_join(as_tibble(nwis),by='site_no')