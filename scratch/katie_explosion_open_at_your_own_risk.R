library(tidyverse)

park <- c("DEVA","JOTR","MOJA")
dist=0.2

source('R/all_functions.R')

sf::sf_use_s2(FALSE)
# read in the NHD

nhd <- getNHD(park,dist)$flowlines
nhd <- nhd$flowlines

# DOWLOADING ALL DATA
nwis <- pullFlowUSGS(park, dist) %>%
  sf::st_write(., 'data/all/nwis_flow_sites_meta.shp')

nwis <- sf::st_read('data/all/nwis_flow_sites_meta.shp')

gw_data <- dataRetrieval::readNWISgwl(unique(nwis$site_no), startDate = "", endDate = "", parameterCd = unique(nwis$code)) %>%
  write_csv(.,'data/nwis/nwis_gw_data.csv')

dv_data <- dataRetrieval::readNWISdv(unique(nwis$site_no), startDate = "", endDate = "", parameterCd = unique(nwis$code)) %>%
  write_csv(., 'data/nwis/nwis_dv_data.csv')

uv_data <- dataRetrieval::readNWISuv(unique(nwis$site_no), startDate = "", endDate = "", parameterCd = unique(nwis$code)) %>%
  write_csv(., 'data/nwis/nwis_uv_data.csv') #not working. why?



# AQUARIUS
aquarius_files <- list.files(path='data/aquarius/', pattern="*.csv", full.names=TRUE)
names <- as_tibble(aquarius_files) %>%
  mutate(name=seq.int(nrow(.)))

aq_codes <- read_csv('data/aquarius/Aquarius_DEVA_16_locs_20220823.csv',skip=1) %>%
  names()

aq_names <- read_csv('data/aquarius/Aquarius_DEVA_16_locs_20220823.csv',skip=2) %>%
  names()

aq_codes <- names(aq)
aq_names <- names(aq)

aq_data <- read.csv('data/aquarius/Aquarius_DEVA_16_locs_20220823.csv', skip=4)


aquarius <- function(aquarius_files) {
 
  site_name <- str_sub(read.csv(paste0(aquarius_files), header=F)[1,1],20)
  dataset <- read.csv(paste0(aquarius_files), skip=1) %>%
    mutate(parm_site=site_name) %>%
    separate(parm_site, c("Parameter","SiteID"), "@") %>%
    rename(timestamp=1)
  
  write_csv(dataset,paste0('PARK_ANALYSIS/AQUARIUS/CLEANED/',namez$name,'.csv'))
  print(paste0(aquarius_files, ' is done'))
}

map(aquarius_files,
    possibly(aquarius, otherwise=1+1))
plyr::ldply(list.files(path="PARK_ANALYSIS/AQUARIUS/CLEANED/", pattern="*.csv", full.names=TRUE), read_csv) %>%
  write_csv('PARK_ANALYSIS/all_aquarius_data.csv') 

# COMID/STREAMCAT STUFF

mutate(site_pretty=paste0("USGS-",site_no))
nwis_list <- nwis$site_pretty

nwis$comid <- NA #attempt 'get_nldi_feature' first
nwis$comid_coords <- NA #if that doesn't work for all gages (not sure why this is happening?), do 'discover_nhdplus_id()'

#first try to get comid using nldi (verified correct comid)
for(i in 1:length(nwis_list)){
  try(nwis$comid[i] <- get_nldi_feature(list("featureSource" = "nwissite", featureID = nwis_list[i]))$comid, silent=T)
}

#ones it didn't work for (n=_____). Perhaps these are new gages?
weirdos <- nwis %>% filter(is.na(comid))

#get the comid using the weirdos' coordinates instead of their gage name
for(i in 1:nrow(nwis)){
  nwis$comid_coords[i] <- discover_nhdplus_id(nwis[i,])
}

nwis <- nwis %>%
  mutate(comid=ifelse(is.na(comid), comid_coords, comid)) %>%
  mutate(comid=as.numeric(comid))

# Water rights
water_rights <- geteWRIMS(park,dist) %>%
  filter(POD_STATUS=="Active") %>%
  mutate(comid=NA)

for(i in 1:nrow(water_rights)){
  water_rights$comid[i] <- discover_nhdplus_id(water_rights[i,])
}

# function that, for every water right POD, finds USGS gages within 20 km up- or downstream.
gages_within_10km <- function(spid_union){
  
  tracer <- function(samples){
    
    gages <- as_tibble(nwis) %>% mutate(comid=as.numeric(comid)) %>% left_join(nhd, by="comid")
    
    outlet <-as_tibble(water_rights) %>%
      dplyr::filter(POD_ID == samples) %>%
      dplyr::left_join(nhd,by="comid")
    
    upstream_nhd <- get_UT(nhd, outlet$comid, distance= 20 + outlet$lengthkm) %>% # upstream trace function in nhdplusTools package
      as_tibble() %>%
      rename(comid = value)
    
    downstream_nhd <- get_DM(nhd, outlet$comid, distance =20 + outlet$lengthkm) %>%
      as_tibble() %>%
      rename (comid = value)
    
    rbind(upstream_nhd,downstream_nhd) %>%
      distinct(comid,.keep_all=TRUE) %>%
      inner_join(.,nwis,by='comid') %>%
      select(site_no,site_name)
    
  }
  
  scat <- map_dfr(spid_union, tracer)
}

nearby_gages <- water_rights %>%
  mutate(gages = map(POD_ID, gages_within_10km))

# Now we have a list of all gages within 20 km of every water right

full_list <- unnest(nearby_gages,cols=gages) #%>% select(SampleName,COMID,gage) %>%
  inner_join(as_tibble(nwis),by='site_no')
  