source("setup.R")

park <- "BRCA"

park_dat <- "data/park/"

if(!dir.exists(paste0(getwd(), "/", park_dat,"/", park))){dir.create(paste0(getwd(), "/", park_dat, "/", park), showWarnings = FALSE)}

# get pack boundary
unit <- getParkBoundary(park = park, save = TRUE, path = "data/park/")

# buffer outside park
buffer <- unit %>%
  sf::st_buffer(., dist = 0.08)

# download aquarius data
Aquarius <- getAquarius(park = park, path = park_dat, system = "Mac")

Aquifers <- getAquifers(aoi = buffer, save = TRUE, path = park_dat)

Buildings <- getBuildings(aoi = buffer, dist = 0)

# not working:
DataStoreList <- listDataStore(park = park, max = 1000, save = TRUE, path = park_dat)
# cannot test:
DataStore <- getDataStore()

GWRecharge <- getGWRecharge(aoi = buffer, dist = 0)

# get noaa data
NOAA <- getNOAA(aoi = buffer, park = park, save = TRUE, path = paste0(path, "/", park, "/"),
                startDate = "1969-01-01", endDate = "2023-12-31")

NPDES <- getNPDES(aoi = buffer, dist = 0)

# find nwis sites
NWISlist <- listNWIS(aoi = buffer, dist = 0)  %>%
  dplyr::mutate(site_type = ifelse(is.na(site_type), "Other", site_type)) %>%
  dplyr::filter(data_type != "Water Quality") %>%
  dplyr::filter(!is.na(code)) %>%
  write_csv(paste0(path, "/", park, "/NWIS_inventory.csv"))

# ***download NWIS data based on nwis site ids
getNWIS(inventory = NWISlist, park = park, path = park_dat, endDate = "2023-12-31", startDate = "1900-01-01")

OmernikII <- getOmernikII(aoi = buffer, save = TRUE, path = paste0(path, "/", park, "/"))

ParkingLots <- getParkingLots(aoi = buffer, dist = 0)

# get NPS system visitation
ParkwideVisitation <- getParkwideVisitation(startYear = 1969, endYear = 2023)

SNOTEL <- getSNOTEL(aoi = buffer, dist = 0, years = 1969:2023,
                    timeseries = "Daily", save = TRUE, path = paste0(path, "/", park, "/"))

Springs <- getSprings(park = park, aoi = buffer, system = "Mac", sites = TRUE)

# get park visitation
UnitVisitation <- getUnitVisitation(units = park, startYear = 1969, endYear = 2023) %>%
  mutate(MY = lubridate::ym(paste0(Year,"-",Month)))

# get nhd watersheds
Watersheds <- getWatersheds(aoi = buffer, save = TRUE, path = paste0(path, "/", park, "/"))

# get a list if water suppliers in utah, and their WRID
WaterSuppliersUtah <- getWaterSuppliersUtah(aoi = buffer, dist = 0)

# ***get use info for a water supplier. (based on their WRID)
WaterUseUtah <- getWaterUseUtah(WRID = 1258)

# Finding current water supply locations:

# BRCA CURRENT EAST CREEK WELLS SUPPLY
# -112.2124, 37.63281
# -112.2115, 37.63198
# BRCA POTENTIAL FUTURE SUPPLY
# -112.2188, 37.67128

# get utah points of diversion
PODUtah <- getPODUtah(aoi = buffer, dist = 0) 

POD_BRCA <- PODUtah %>%
  dplyr::mutate(GPM = CFS * 448.8309375) %>%
  filter(TYPE == "Underground") %>%
  filter(park_right == "Park")

mapview(POD_BRCA) 

# THE CLUSTER IN NORTHWEST ARE THE CURRENT SUPPLY WELLS BASED
# ON ESTIMATED COORDINATES FROM DIGITAL MAPS OF THE SYSTEM
current <- POD_BRCA[4:6,]

maca_grids <- st_read("data/CCRP_automated_climate_futures/spatial-data/Climate_grid/MACA_grid.shp") %>%
 .[current,]

mapview(current) + mapview(maca_grids)

ws <- vector("list", nrow(current))

# get the watersheds of different points:
for(i in 1:nrow(current)){
  
  ws[[i]] <- current[i,] %>% getXYWatersheds(sf = ., coordinates = NULL)

}

ws <- ws %>% bind_rows() %>% distinct(featureid, .keep_all = TRUE)

mapview(ws)

lines <- vector("list", nrow(current))

# get the watersheds of different points:
for(i in 1:nrow(current)){
  
  lines[[i]] <- current[i,] %>% getXYFlowlines(sf = ., coordinates = NULL) 
  
}

lines <- lines %>% bind_rows() %>% distinct(comid, .keep_all = TRUE) %>% 
  summarize()

# ... all are clearly in the same watershed. but a way to pull in all areas 
# in case they aren't... will dissolve the catchments into just one layer

ws <- ws %>% summarize() 

maca_ws <- st_read("data/CCRP_automated_climate_futures/spatial-data/Climate_grid/MACA_grid.shp") %>%
  .[ws,]

mapview(ws) + mapview(maca_ws) + mapview(current) + mapview(lines) + mapview(PODUtah)


ws <- vector("list", nrow(current))

# get the watersheds of different points:
for(i in 1:nrow(current)){
  
  ws[[i]] <- current[i,] %>% getXYWatersheds(sf = ., coordinates = NULL)
  
}

ws <- ws %>% bind_rows() %>% distinct(featureid, .keep_all = TRUE)

mapview(ws)

lines <- vector("list", nrow(current))

# get the watersheds of different points:
for(i in 1:nrow(current)){
  
  lines[[i]] <- current[i,] %>% getXYFlowlines(sf = ., coordinates = NULL) 
  
}

lines <- lines %>% bind_rows() %>% distinct(comid, .keep_all = TRUE) %>% 
  summarize()

# ... all are clearly in the same watershed. but a way to pull in all areas 
# in case they aren't... will dissolve the catchments into just one layer

ws <- ws %>% summarize() 

maca_ws <- st_read("data/CCRP_automated_climate_futures/spatial-data/Climate_grid/MACA_grid.shp") %>%
  .[ws,]

mapview(ws) + mapview(maca_ws) + mapview(current) + mapview(lines) + mapview(PODUtah)

# Future supply:
PODFuture <- PODUtah %>%
  filter(WRNUM == "61-1143")
  
  ws_future <- getXYWatersheds(sf = PODFuture, coordinates = NULL)

mapview(ws)

  lines_future <- getXYFlowlines(sf = PODFuture, coordinates = NULL) 

  
  mapview(ws_future)+mapview(PODFuture)+mapview(lines_future)
# ... all are clearly in the same watemapview()# ... all are clearly in the same watershed. but a way to pull in all areas 
# in case they aren't... will dissolve the catchments into just one layer

ws <- ws %>% summarize() 

maca_ws <- st_read("data/CCRP_automated_climate_futures/spatial-data/Climate_grid/MACA_grid.shp") %>%
  .[ws,]

mapview(ws) + mapview(maca_ws) + mapview(current) + mapview(lines) + mapview(PODUtah)



