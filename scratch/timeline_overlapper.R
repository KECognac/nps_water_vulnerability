
```{r, eval = FALSE}
# load in all wbm tables:
all_wbm_runoff <- list.files('data/misc/wbm_hist/', pattern = "*runoff", full.names = TRUE) %>%
  map_dfr(~read_csv(.)) %>%
  data.table::data.table() %>%
  mutate(year = lubridate::year(time),
         month = lubridate::month(time))

gage_wbm <- all_wbm_runoff %>% 
  # convert to shapefile:
  st_as_sf(coords = c("lon", "lat"), crs = 4269) %>%
  st_join(., nldi_watershed, left = FALSE) %>%
  select(site_no, x, y, year, month, var, val)

mapview(gage_wbm, zcol = "site_no")
# ... looks right!

total_wbm_monthly <- gage_wbm %>%
  group_by(site_no, month, year) %>%
  summarize(total_runoff = sum(val))

all_nwis_flow <- list.files("data/misc/nwis/dv/", full.names = TRUE) %>%
  map_dfr(~ read_csv(.) %>% 
            data.table::data.table() %>% 
            mutate(across(everything(), as.character))) %>%
  bind_rows() %>%
  mutate(dateTime = lubridate::ymd(dateTime),
         flow_cfs = as.numeric(X_00060_00003)) %>%
  left_join(st_drop_geometry(nldi_watershed), by = "site_no") %>%
  mutate(flow_mmd = 1000*(flow_cfs*0.028316847000000252*86400)/(drain_sqkm*1000000)) 

monthly_flow <- all_nwis_flow %>%
  mutate(year = lubridate::year(dateTime),
         month = lubridate::month(dateTime),
         ym = ym(substr(dateTime, 1, 7))) %>%
  filter(year >= "1980" & year <= "2022") %>%
  group_by(site_no, month, year, ym) %>%
  summarize(mean_flow = mean(flow_mmd)) 

comparison <- inner_join(monthly_flow, total_wbm_monthly, by = c("site_no", "month", "year")) %>%
  mutate(season = case_when(month %in% c(12,1,2,3,4) ~ "Winter",
                            month %in% c(5,6) ~ "Runoff",
                            month %in% c(7,8,9,10,11) ~ "Baseflow"))

ggplot(data = comparison) +
  geom_point(aes(x = mean_flow, y = total_runoff, color = month)) +
  facet_wrap(~site_no, nrow = 2) +
  theme_bw()

# Find instances where the WBM says there is NO runoff, but 
# the data says otherwise...
no_runoff <- comparison %>%
  filter(total_runoff == 0)

ggplot(data = no_runoff) +
  geom_histogram(aes(x = mean_flow, fill = as.factor(month))) + 
  theme_bw()


# How does precipitation compare to streamflow and well data?
# Find NOAA weather stations near our areas of interest
noaa_data <- getNOAA(aoi = st_buffer(final_aoi, 0.1), park = "misc") %>%
  #              prcp = Precipitation (tenths of mm)
  #    	         snow = Snowfall (mm)
  # 	           snwd = Snow depth (mm)
  #              tmax = Maximum temperature (tenths of degrees C)
  #              tmin = Minimum temperature (tenths of degrees C)
  #              elevation = meters
  select(name, id, date, tmax, tmin, prcp, snow, snwd, elevation, geometry) %>%
  # Raw NOAA data is in "tenths of" units for temp and precip:
  mutate_at(c("tmax", "tmin", "prcp"), function(x) {x * 0.10})

noaa_data_sub <- noaa_data %>%
  data.table::data.table() %>%
  mutate(ym = ym(substr(date, 1, 7))) %>%
  filter(year(ym) >= 1980 & year(ym) <= 2022) %>%
  group_by(name, id, ym, geometry) %>%
  summarize(tmax = mean(tmax, na.rm = TRUE),
            tmin = mean(tmin, na.rm = TRUE),
            tmean = ((tmax+tmin)/2),
            prcp = sum(prcp, na.rm = TRUE),
            snow = sum(snow, na.rm = TRUE),
            snwd = max(snwd, na.rm = TRUE)) %>%
  st_as_sf()

noaa_data_daily <- noaa_data %>%
  data.table::data.table() %>%
  mutate(ym = ym(substr(date, 1, 7))) %>%
  filter(year(ym) >= 1980 & year(ym) <= 2022) %>%
  st_as_sf()

# ymd("2022-01-01") - ymd("1980-01-01")
# Time difference of 15341 days
# 15341 * 0.8 = 12273

# drop to sites that have more than 80% of the years
# noaa_years <- noaa_data %>%
#   data.table::data.table() %>%
#   mutate(ym = ym(substr(date, 1, 7))) %>%
#   filter(year(ym) >= 1980 & year(ym) <= 2022) %>%
#   group_by(name) %>%
#   filter(!is.na(prcp)) %>%
#   summarize(data = n_distinct(date))

ggplot(noaa_data_sub) +
  geom_point(aes(x = ym, y = prcp)) +
  facet_wrap(~name)

# NWIS flow data
# 
# For each stream gage of interest, find the nearest weather station with the most complete data record available (at the time that the NWIS gage was running between 1980-2022). The stream gage also needs to have at least 80% complete data for its time period. Here, I am using cross-correlation to explore the relationship and time lag between the two distinct time series. Cross-correlation helps identify if changes in one time series are followed by changes in another, with a certain time delay.

monthly_data <- all_brca_data %>%
  mutate(year = lubridate::year(ym),
         month = lubridate::month(ym)) %>%
  filter(year >= "1980" & year <= "2022") 

monthly_flow_timeline <- all_brca_data %>%
  filter(year(dateTime) >= 1980 & year(dateTime) <= 2022) %>%
  group_by(site_no) %>%
  summarize(min = min(dateTime),
            max = max(dateTime),
            possible_n = (as.numeric(ymd(max(dateTime)) - ymd(min(dateTime))) + 1),
            actual_n = n()) %>%
  filter(actual_n >= (possible_n * 0.8))

time_pd_merger <- function(site){
  
  bounds <- monthly_flow_timeline %>%
    dplyr::filter(site_no == site)
  
  nwis_loc <- nwis %>%
    dplyr::filter(site_no == site)
  
  precip_data <- noaa_data %>%
    filter(!is.na(prcp)) %>%
    group_by(name) %>%
    filter(date >= bounds$min & date <= bounds$max) %>%
    summarize(actual_n = n()) %>%
    filter(actual_n >= (bounds$possible_n * 0.8)) #%>%
  
  nwis_loc$nearest_station <- st_nearest_feature(nwis_loc, precip_data)
  
  nwis_loc <- nwis_loc %>%
    mutate(distance = sf::st_distance(nwis_loc, precip_data[nwis_loc$nearest_station,], by_element = TRUE),
           nearest_station = precip_data[nwis_loc$nearest_station,]$name)
  
  return(nwis_loc)
  
}

flows_n_noaa <- unique(monthly_flow_precip$site_no) %>%
  map_dfr(~time_pd_merger(.)) 

new <- left_join(monthly_flow, flows_n_noaa, by = "site_no") %>%
  inner_join(noaa_data_sub, by = c("nearest_station" = "name", "ym"))

ggplotly(
  ggplot() +
    geom_line(data = new, aes(x = ym, y = mean_flow), color = "#B8C7F4") +
    geom_line(data = new, aes(x = ym, y = prcp), color = "#002FA7") +
    facet_wrap(~site_no, nrow = 2) +
    theme_minimal()
)

# 
# Interpretation:
# 
# NWIS flow data
# 
# For each stream gage of interest, find the nearest weather station with the most complete data record available (at the time that the NWIS gage was running between 1980-2022). The stream gage also needs to have at least 80% complete data for its time period. Here, I am using cross-correlation to explore the relationship and time lag between the two distinct time series. Cross-correlation helps identify if changes in one time series are followed by changes in another, with a certain time delay.

# Subset our NWIS data to the time period of interest:
daily_nwis_flow <- all_nwis_flow %>%
  filter(year(dateTime) >= "1980" & year(dateTime) <= "2022") 

# Find how much data is available during this time period for each site:
daily_nwis_timeline <- daily_nwis_flow %>%
  group_by(site_no) %>%
  filter(!is.na(flow_cfs)) %>%
  summarize(min = min(dateTime), #start date
            max = max(dateTime), #end date
            # how many days exist between the start and end date
            possible_n = (as.numeric(ymd(max(dateTime)) - ymd(min(dateTime))) + 1),
            # how many days we have a record for:
            actual_n = n()) %>%
  # select only sites who have at least 80% of days covered
  filter(actual_n >= (possible_n * 0.8))

time_pd_merger <- function(site){
  
  bounds <- daily_nwis_timeline %>%
    dplyr::filter(site_no == site)
  
  nwis_loc <- nwis %>%
    dplyr::filter(site_no == site)
  
  precip_data <- noaa_data %>%
    filter(!is.na(prcp)) %>%
    group_by(name) %>%
    filter(date >= bounds$min & date <= bounds$max) %>%
    summarize(actual_n = n()) %>%
    # must be at least an 80% overlap between USGS and NOAA datasets:
    filter(actual_n >= (bounds$possible_n * 0.8))
  
  # Find the nearest NOAA station that meets the minimum data requirements:
  nwis_loc$nearest_station <- st_nearest_feature(nwis_loc, precip_data)
  
  # Grab the actual distance between the nearest NOAA station and the USGS gage
  nwis_loc <- nwis_loc %>%
    mutate(distance_to_station = sf::st_distance(nwis_loc, precip_data[nwis_loc$nearest_station,], by_element = TRUE),
           nearest_station = precip_data[nwis_loc$nearest_station,]$name) %>%
    select(site_no, nearest_station, distance_to_station)
  
  return(nwis_loc)
  
}

flows_n_noaa <- unique(daily_nwis_flow$site_no) %>%
  map_dfr(~time_pd_merger(.)) 

new <- left_join(daily_nwis_flow, flows_n_noaa, by = "site_no") %>%
  inner_join(., noaa_data_daily, by = c("nearest_station" = "name", "dateTime" = "date"))

ggplotly(
  ggplot() +
    geom_line(data = new, aes(x = dateTime, y = flow_mmd * 10^12), color = "#B8C7F4") +
    geom_line(data = new, aes(x = dateTime, y = prcp), color = "#002FA7") +
    facet_wrap(~site_no, nrow = 2) +
    theme_minimal()
)


# What about with the well data?


# Subset our NWIS data to the time period of interest:
daily_well_static <- well_daily %>%
  filter(year(date) >= "1980" & year(date) <= "2022") 

# Find how much data is available during this time period for each site:
daily_well_timeline <- daily_well_static %>%
  group_by(well) %>%
  filter(!is.na(static_in)) %>%
  summarize(min = min(date), #start date
            max = max(date), #end date
            # how many days exist between the start and end date
            possible_n = (as.numeric(ymd(max(date)) - ymd(min(date))) + 1),
            # how many days we have a record for:
            actual_n = n()) %>%
  mutate(completeness = 100 * (actual_n/possible_n))

time_pd_merger <- function(site){
  
  bounds <- daily_well_timeline %>%
    dplyr::filter(well == site)
  
  nwis_loc <- nwis %>%
    dplyr::filter(well == site)
  
  precip_data <- noaa_data %>%
    filter(!is.na(prcp)) %>%
    group_by(name) %>%
    filter(date >= bounds$min & date <= bounds$max) %>%
    summarize(actual_n = n()) %>%
    # must be at least an 80% overlap between USGS and NOAA datasets:
    filter(actual_n >= (bounds$possible_n * 0.8))
  
  # Find the nearest NOAA station that meets the minimum data requirements:
  nwis_loc$nearest_station <- st_nearest_feature(nwis_loc, precip_data)
  
  # Grab the actual distance between the nearest NOAA station and the USGS gage
  nwis_loc <- nwis_loc %>%
    mutate(distance_to_station = sf::st_distance(nwis_loc, precip_data[nwis_loc$nearest_station,], by_element = TRUE),
           nearest_station = precip_data[nwis_loc$nearest_station,]$name) %>%
    select(site_no, nearest_station, distance_to_station)
  
  return(nwis_loc)
  
}

flows_n_noaa <- unique(daily_nwis_flow$site_no) %>%
  map_dfr(~time_pd_merger(.)) 

new <- left_join(daily_nwis_flow, flows_n_noaa, by = "site_no") %>%
  inner_join(., noaa_data_daily, by = c("nearest_station" = "name", "dateTime" = "date"))

ggplotly(
  ggplot() +
    geom_line(data = new, aes(x = dateTime, y = flow_mmd * 10^12), color = "#B8C7F4") +
    geom_line(data = new, aes(x = dateTime, y = prcp), color = "#002FA7") +
    facet_wrap(~site_no, nrow = 2) +
    theme_minimal()
)

corr_finder <- function(site){
  
  sub <- new %>%
    filter(site_no == site) %>%
    select(site_no, dateTime, prcp, flow_mmd) %>%
    mutate(flow_mmd_filled = zoo::na.approx(flow_mmd),
           prcp_filled = ifelse(is.na(prcp), 0, prcp))
  
  precip <- ts(sub$prcp_filled, start = 1)
  flow <- ts(sub$flow_mmd_filled, start = 1)
  
  cross_correlation <- ccf(precip, flow)
  
  # Plot the cross-correlation function
  plot(cross_correlation, main = "Cross-Correlation Function", xlab = "Lag", ylab = "Correlation")
  
}


# What does this NPS WBM data look like mapped?


all_wbm_runoff <- list.files('data/misc/wbm_hist/', pattern = "*runoff", full.names = TRUE) %>%
  map_dfr(~read_csv(.)) %>%
  data.table::data.table() %>%
  mutate(year = lubridate::year(time),
         month = lubridate::month(time),
         ym = ym(substr(time, 1, 7))) %>%
  group_by(year, lat, lon) %>%
  summarize(mean = mean(val, na.rm = TRUE)) 
# st_as_sf(coords = c("lon", "lat"), crs = 4269)

animated_plot <- ggplot() +
  geom_point(data = all_wbm_runoff, aes(x = lon, y = lat, color = mean, size = 2)) +
  coord_quickmap(xlim = c(min(all_wbm_runoff$lon), max(all_wbm_runoff$lon)), 
                 ylim = c(min(all_wbm_runoff$lat), max(all_wbm_runoff$lat))) +
  labs(title = 'Mean annual runoff in areas of interest',
       subtitle = 'Year: {frame_time}',
       caption = 'Source: NPS Water Balance Model') +
  theme_minimal() +
  theme(legend.position = "bottom") +
  gganimate::transition_time(year) +
  scale_color_gradientn(colors = c("#B8C7F4", "#002FA7", "#FF69B4", "#C15A42"), breaks = c(10, 100, 1000))

num_years <- max(all_wbm_runoff$year) - min(all_wbm_runoff$year) + 1
gganimate::animate(animated_plot, nframes = num_years, fps = 2)

```
