#' Tidying raw Aquarius datasets
#' 
#' This function tidies and merges individual datasets downloaded from the NPS Aquarius
#' Data Portal. 
#' 
#' @param aquarius_raw The directory in which the raw Aquarius data lives
#' @param save Whether to save (TRUE) the resulting dataset or not (FALSE)
#' @param path If `save = TRUE`, the file path to save the tidied Aquarius table
#' 
#' @return A dataset containing tidied Aquarius data
cleanAquarius <- function(aq_raw_path, save = FALSE, path = NULL){
  
  aquarius_files <- list.files(path=aq_raw_path, pattern="*.csv", full.names=TRUE, recursive=TRUE) %>%
    tibble::as_tibble()
  
  aquarius <- function(aquarius_union) {
    
    tidier <- function(dataset){
      
      file <- aquarius_files %>%
        dplyr::filter(value==dataset)
      
      site_name <- stringr::str_sub(read.csv(paste0(file$value), header=F)[1,1],20)
      
      unit <- gsub("Value..","",names(read.csv(paste0(file$value), skip=1) %>% select(3)))  
      
      read.csv(paste0(file$value), skip=1) %>%
        dplyr::mutate(parm_site=site_name) %>%
        tidyr::separate(parm_site, c("parameter","siteID"), "@") %>%
        dplyr::rename(timestamp=1,
                      val=3) %>%
        dplyr::mutate(timestamp=as.character(timestamp),
                      units=unit)
    }
    
    ali <- purrr::map_dfr(aquarius_union,tidier)
    
  }
  
  tidiest <- aquarius_files %>%
    dplyr::mutate(my_pretty = map(value, aquarius)) %>%
    tidyr::unnest(cols=my_pretty) %>%
    mutate(UNIT_CODE=substr(siteID,1,4)) %>%
    select(c(timestamp,siteID,parameter,val,units,UNIT_CODE))
  
  
  if(save == TRUE){
    write.csv(tidiest, paste0(path, "/aquarius_data.csv"))
    
  }
  
  return(tidiest)
  
}
