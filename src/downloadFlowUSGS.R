#' Inventory of USGS flow data near park units
#' 
#' This function imports an inventory of available flow data from the USGS National Water Information System (https://waterdata.usgs.gov/nwis)
#' 
#' @param inventory A data table derived from NWIS, often retrieved from `pullFlowUSGS()`.
#' @param startDate The distance (in the same units used by `getParkBoundary()`) to buffer around park boundary
#' @param endDate Whether to save the resulting file (TRUE/FALSE)
#' @param path The file path (within the working directory) that all data is saved to
#' @return An sf object of USGS gaging stations within given spatial boundary and attributes

inventory <- sf::st_read('data/nwis/nwis_flow_inventory.shp') %>%
  dplyr::mutate(combo=paste0(site_no,"-",code)) %>%
  dplyr::filter(!grepl("sediment",paramtr,ignore.case=T))

downloadFlowUSGS <- function(inventory, path, endDate = "", startDate = ""){

  dir.create(file.path(getwd(),"/",path,"dv/"), showWarnings = FALSE)
  dir.create(file.path(getwd(),"/",path,"uv/"), showWarnings = FALSE)
  dir.create(file.path(getwd(),"/",path,"qw/"), showWarnings = FALSE)
  dir.create(file.path(getwd(),"/",path,"gwl/"), showWarnings = FALSE)
  
  # DAILY

daily <- inventory %>%
  dplyr::filter(dt_typ_=="dv") %>%
  distinct(.,.keep_all=TRUE)

list <- unique(daily$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(daily, combo==list)
  
  dataRetrieval::readNWISdv(unique(ind$site_no), unique(ind$code),
                            startDate=startDate, endDate=endDate) %>%
    write.csv(
      paste0('data/nwis/dv/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

purrr::map(list,
    purrr::possibly(nwis_puller, otherwise=1+1))

nwis_dv <- plyr::ldply(list.files(path="data/nwis/dv/",
                                  pattern="*.csv",
                                  full.names=TRUE),
                       read_csv)

print('Daily data pulled')

# UNIT

uv <- inventory %>%
  dplyr::filter(dt_typ_ == "uv") %>%
  distinct(.keep_all=TRUE)

list <- unique(uv$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(uv, combo==list)
  
  dataRetrieval::readNWISuv(unique(ind$site_no), unique(ind$code),
                            startDate=startDate, endDate=endDate) %>%
    write.csv(
      paste0('data/nwis/uv/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

map(list,
    possibly(nwis_puller, otherwise=1+1))

nwis_uv <- plyr::ldply(list.files(path="data/nwis/uv/",
                                  pattern="*.csv",
                                  full.names=TRUE),
                       read_csv)

print('Unit data pulled')

# Instantaneous

qw <- inventory %>%
  dplyr::filter(dt_typ_ == "qw") %>%
  distinct(.keep_all=TRUE)

list <- unique(qw$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(qw, combo==list)
  
  dataRetrieval::readNWISqw(unique(ind$site_no), unique(ind$code),
                            startDate=startDate, endDate=endDate) %>%
    write.csv(
      paste0('data/nwis/qw/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

map(list,
    possibly(nwis_puller, otherwise=1+1))

nwis_qw <- plyr::ldply(list.files(path="data/nwis/qw/",
                                  pattern="*.csv",
                                  full.names=TRUE),
                       read_csv)

print('Instantaneous data pulled')


# GROUNDWATER

gwl <- inventory %>%
  dplyr::filter(dt_typ_ == "gw") %>%
  distinct(.,.keep_all=TRUE)


list <- unique(gwl$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(gwl, combo==list)
  
  dataRetrieval::readNWISgwl(unique(ind$site_no), unique(ind$code),
                             startDate=startDate, endDate=endDate) %>%
    write.csv(
      paste0('data/nwis/gwl/',unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

map(list,
    possibly(nwis_puller, otherwise=1+1))

nwis_gwl <- plyr::ldply(list.files(path="data/nwis/gwl/",
                                   pattern="*.csv",
                                   full.names=TRUE),
                        read_csv)

print('Groundwater data pulled')

# Bind datasets together

# return all nhd sf features
obj <- list(nwis_dv, nwis_uv, nwis_qw, nwis_gwl)

names(obj) <- c("daily", "unit", "instantaneous", "groundwater")

return(obj)

}
