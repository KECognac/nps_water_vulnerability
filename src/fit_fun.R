# Define optimization function that takes function arguments as input and
# returns objective function result as output.
# Note, function to optimize is hard-coded here as ihacres_routing_gw.R
# can change function args in future to change up function and pars.

fit_fun <- function(params, 
                    plot =FALSE, 
                    return_dat = FALSE, 
                    dat = "cal_data",
                    obj = "MAE") {
  
  params <- as.numeric(params)
  
  data_in <- get(dat)
  Q_in <- data_in$Q
  U_in <- data_in$P
  #tau_g <- params[5] # 3s only
  #R <- params[6]     # 3s only 
  
  Q_mod <-ihacres_routing_gw(U = U_in, 
                             tau_q = params[1], 
                             tau_s = params[2], 
                             vs = params[3], 
                             delay = as.integer(params[4]), 
                             loss = params[5])
  
  #Q_mod <-ihacres_routing_3S(U = U_in, tau_q, tau_s, vs, delay, loss, tau_g, R)
  
  er_sse <- SSE(estimated = Q_mod, observed = Q_in)
  er_mae <- MAE(estimated = Q_mod, observed = Q_in)
  er_nser2 <- -NSE_R2(estimated = Q_mod, observed = Q_in)
  er_r2log <- -R2_LOG(estimated = Q_mod, observed = Q_in)
  er_rmse <- RMSE(estimated = Q_mod, observed = Q_in)
  er_bias <- BIAS(estimated = Q_mod, observed = Q_in)
  
  all_err <- c("MAE" = er_mae, 
               "SSE" = er_sse,
               "NSE_R2" = -er_nser2,
               "RMSE" = er_rmse,
               "BIAS" = er_bias,
               "R2_LOG" = -er_r2log)
  
  #print(er)
  
  if (plot) {
    a<- autoplot(cbind(Q_in,Q_mod),
                 facet = FALSE, size = 1) + 
      labs(y = "Discharge (in/d)") +
      scale_color_manual("",values = c("black","dodgerblue"),
                         labels("Q_obs","Q_mod"))
    print(a)
    if (return_dat == FALSE) {
      return(a)
    }
  }
  
  if (return_dat == FALSE) { 
    # Just return objective function value
    if (obj == "MAE") {
      return(er_mae)
    } 
    else if (obj == "SSE") {
      return(er_sse)
    }
    else if (obj == "NSE_R2") {
      return(er_nser2)
    }
    else if (obj == "RMSE") {
      return(er_rmse)
    }
    else if (obj == "BIAS") {
      return(er_bias)
    }
    else if (obj == "R2_LOG") {
      return(er_r2log)
    }
    else if (obj == "all") {
      return(all_err)
    }
    else {
      return(NA)
    }
  } 
  else if (return_dat == TRUE) {
    return(list(Q_mod = Q_mod, obj = all_err))
  }
  
}
