# Downloads WBM outputs derived from GridMET. Found at:
# http://www.yellowstone.solutions/thredds/catalog/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/catalog.html

getHistoricWBMGridMET <- function(time = "monthly",
                                  park,
                                  aoi,
                                  path = "data/",
                                  wb_vars = c("soil_water",
                                              "runoff",
                                              "rain",
                                              "accumswe",
                                              "PET",
                                              "Deficit",
                                              "AET")) {
  
  options(timeout = 9000)
  
  years <- 1980:2022
  
  map_dat <- tidyr::crossing(years, wb_vars)
  
  if (time == "monthly") {
    
    # CM:can't create multiple sub directories with dir.create() so split it up
    if (!dir.exists(paste0(path, "/", park))) {
      dir.create(paste0(path, "/", park))
    }
    
    if (!dir.exists(paste0(path, "/", park, "/wbm_gridmet_hist/"))) {
      dir.create(paste0(path, "/", park, "/wbm_gridmet_hist"))
    }
    
    # folder to save temp netcdf in
    if (!dir.exists("templeod_dataall/")) {
      dir.create("templeod_dataall/")
    }
    
    start <- Sys.time()
    
    table <- vector("list", length = nrow(map_dat))
    
    for (i in 1:nrow(map_dat)) {
      
      call <- paste0(
        "http://www.yellowstone.solutions/thredds/fileServer/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/V_1_5_",
        map_dat$years[i],
        "_gridmet_historical_",
        map_dat$wb_vars[i],
        "_monthly.nc4")
      
      download.file(call, destfile = "templeod_dataall/data.nc4")
      
      # read in netCDF
      wb_dat <- stars::read_ncdf("templeod_dataall/data.nc4")
      
      # transform crs of aoi (faster than transforming netCDF)
      aoi <- aoi %>%
        sf::st_transform(st_crs(wb_dat))
      
      # crop gridmet data to park and clean for export
      wb_dat_clean <- st_crop(wb_dat, aoi, crop = TRUE) %>%
        terra::as.data.frame(., xy = TRUE) %>%
        # filter NAs (this will return just the points within the park)
        dplyr::filter(!is.na(!!sym(map_dat$wb_vars[i]))) %>%
        dplyr::mutate(ym = ym(str_sub(time, 1, 7)),
                      var = map_dat$wb_vars[i],
                      val = 3) %>%
        dplyr::select(ym, var, val)
      
      table[[i]] <- wb_dat_clean
      
      print(i)
      
    }
    
    table_all <- bind_rows(table)
    # clean here, there will be NAs from binds dfs/ with different colummn names
    
    end <- Sys.time()
    
    end - start
    
    unlink("templeod_dataall", recursive = TRUE)
    
    write_csv(
      table_all,
      file = paste0(
        path,
        "/",
        park,
        "/wbm_gridmet_hist/",
        park,
        "_gridmet_monthly.csv"
      )
    )
    
  }
  
  
  if(time == "daily"){
    
    # CM:can't create multiple sub directories with dir.create() so split it up
    if (!dir.exists(paste0(path, "/", park))) {
      dir.create(paste0(path, "/", park))
    }
    
    if (!dir.exists(paste0(path, "/", park, "/wbm_gridmet_hist_daily/"))) {
      dir.create(paste0(path, "/", park, "/wbm_gridmet_hist_daily"))
    }
    
    # folder to save temp netcdf in
    if (!dir.exists("templeod_dataall/")) {
      dir.create("templeod_dataall/")
    }
    
    if (!dir.exists(paste0(path, "/", park, "/wbm_gridmet_hist_daily/temp"))) {
      dir.create(paste0(path, "/", park, "/wbm_gridmet_hist_daily/temp"))
    }
    
    start <- Sys.time()
    
    for(i in 1:nrow(map_dat)){
      #http://www.yellowstone.solutions/thredds/fileServer/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/V_1_5_2022_gridmet_historical_rain.nc4
      call <- paste0("http://www.yellowstone.solutions/thredds/fileServer/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/V_1_5_",
                     map_dat$years[i], "_gridmet_historical_", map_dat$wb_vars[i], ".nc4")
      
      download.file(call, destfile = "templeod_dataall/data.nc4")
      
      # read in netCDF
      wb_dat <- stars::read_ncdf("templeod_dataall/data.nc4")
      
      # transform crs of aoi (faster than transforming netCDF)
      aoi <- aoi %>%
        sf::st_transform(st_crs(wb_dat))
      
      # crop gridmet data to park and clean for export
      wb_dat_clean <- st_crop(wb_dat, aoi, crop = TRUE) %>%
        terra::as.data.frame(., xy = TRUE) %>%
        # filter NAs (this will return just the points within the park)
        dplyr::filter(!is.na(!!sym(map_dat$wb_vars[i]))) %>%
        dplyr::rename(val = 4) %>%
        dplyr::mutate(date = ymd(str_sub(time, 1, 10)),
                      var = map_dat$wb_vars[i]) %>%
        dplyr::select(x,
                      y, 
                      date, 
                      var,
                      val)
      
      # back up because this download is slow and seems to break a lot....
      write_csv(
        wb_dat_clean,
        file = paste0(
          path,
          "/",
          park,
          "/wbm_gridmet_hist_daily/temp/",
          park, "_", map_dat$wb_vars[i],
          "_", map_dat$years[i],
          "_gridmet_daily.csv"
        ))
      
      table[[i]] <- wb_dat_clean
      
      print(i)
      
    }
    
    table_all <- list.files(paste0(path,
                                   "/",
                                   park,
                                   "/wbm_gridmet_hist_daily/temp/"),
                            full.names = TRUE) %>%
      purrr::map(~data.table::fread(.)) %>%
      bind_rows() %>%
      dplyr::select(x, y, date, var, val)
    
    end <- Sys.time()
    
    end - start
    
    unlink("templeod_dataall", recursive = TRUE)
    
    write_csv(
      table_all,
      file = paste0(
        path,
        "/",
        park,
        "/wbm_gridmet_hist_daily/",
        park,
        "_gridmet_daily.csv"
      )
    )
    
  }
  
  return(table_all)
  
}
