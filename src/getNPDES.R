#' Import and clean Utah Water Rights Point of Diversion Data
#' This function imports geospatial data from the Utah Geospatial Resource Center (https://opendata.gis.utah.gov/datasets/utahDNR::utah-points-of-diversion/explore?location=40.989324%2C-114.748636%2C-1.00)
#' 
#' @param aoi An sf polygon object, often a park boundary (or boundaries) retrieved from `getParkBoundary()`.
#' @param dist The distance (in the same units used in  `park`) to buffer around spatial object `park`
#' 
#' @return An sf object of points of diversion within given spatial boundary and attributes
getNPDES <- function(aoi, save=FALSE, path){
  
  usa <- USAboundaries::us_states() %>%
    sf::st_transform(4269)
  
  # states needed for download
  
  states <- unique(tolower(sf::st_join(aoi, usa)$stusps))

  downloader <- function(states){
    
    call <- paste0("https://ordsext.epa.gov/FLA/www3/state_files/state_combined_",states,".zip")
    temp1 <- tempfile()
    download.file(paste0(call), destfile = temp1, method = "curl")
  
  temp2 <- tempfile()
  unzip(temp1, exdir = temp2)
  
  sf::sf_use_s2(FALSE)
  
  frs <- read_csv(list.files(path=temp2, pattern = "GIS_FILE", full.names = TRUE, recursive = TRUE)) %>%
    filter(!is.na(LATITUDE83)) %>%
    st_as_sf(coords = c("LONGITUDE83","LATITUDE83"), crs = 4269)
  
  return(frs)
  
  }
  
frs <- map(states, downloader) %>%
  bind_rows
  
  # add buffer around park boundary
  aoi_buffer <- aoi %>% 
    sf::st_buffer(dist = dist)
  
  #join sf object and table attributes and filter to park boundary region of interest
  nearby_frs <- frs %>%    
    sf::st_intersection(., dplyr::select(aoi_buffer, UNIT_CODE)) %>%
    sf::st_join(.,dplyr::select(aoi, within = UNIT_CODE), left = TRUE) %>%
    dplyr::mutate(#park_right = ifelse(grepl("National Park", OWNER, ignore.case = T), "Park","Non-park"),
                  within_park = ifelse(!is.na(within), "Within Park", NA)) %>%
    select(-within)
  
  return(nearby_wr)
  
}


