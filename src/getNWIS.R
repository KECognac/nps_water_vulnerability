#' Inventory of USGS flow data near park units
#' 
#' This function imports an inventory of available flow data from the USGS National Water Information System (https://waterdata.usgs.gov/nwis)
#' 
#' @param inventory A data table listing available data (site number, parameter code) from NWIS, often retrieved from `pullFlowUSGS()`.
#' @param startDate Start date for data pull (default=all dates)
#' @param endDate End date for data pull (default=all dates)
#' @param path The file path (within the working directory) that all data is saved to
#'
#' @return An sf object of USGS gaging stations within given spatial boundary and attributes
#'
#' @seealso [pullFlowUSGS()]
getNWIS <- function(inventory, path, endDate = "", startDate = ""){
  
  for(i in length(park)){
    
    dir.create(file.path(getwd(),"/",path,"/",park[i]), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/dv/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/uv/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/qw/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/gw/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/pk/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/ad/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/sv/"), showWarnings = FALSE)
    dir.create(file.path(getwd(),"/",path,"/",park[i],"/aw/"), showWarnings = FALSE)
    
    inventory <- inventory %>%
      mutate(combo=paste0(site_no,"-",code)) %>%
      filter(UNIT_CODE == park[2])
    
    codes <- c("dv", "gw", "uv", "pk", "ad", "sv", "aw")
    
    coder <- function(codes){
      
      code_data <- inventory %>%
        dplyr::filter(data_type_cd==codes) %>%
        distinct(.,.keep_all=TRUE) %>%
        dplyr::filter(!is.na(code))
      
      list <- unique(code_data$combo)
      
      nwis_puller <- function(list){
        
        ind <- dplyr::filter(code_data, combo == list)
        
        dataRetrieval::readNWISdata(sites=unique(ind$site_no), parameterCd=unique(ind$code),
                                    service=codes,
                                    startDate=ind$begin_date, endDate=ind$end_date) %>%
          write_csv(
            paste0(getwd(),"/",path,"/",park[i],"/",codes,"/",unique(ind$site_no),'_',unique(ind$code),'.csv'))
        
        print(paste0(ind$site_name, ":", ind$parameter, " for ", park, " done!"))
        
      }
      
      purrr::map(list,
                 purrr::possibly(nwis_puller, otherwise=1+1))
      
    }
    
    purrr::map(codes,
               purrr::possibly(coder, otherwise=1+1))
    
  }
  
}

