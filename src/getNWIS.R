#' Inventory of USGS flow data near park units
#' 
#' This function imports an inventory of available flow data from the USGS National Water Information System (https://waterdata.usgs.gov/nwis)
#' 
#' @param inventory A data table listing available data (site number, parameter code) from NWIS, often retrieved from `pullFlowUSGS()`.
#' @param startDate Start date for data pull (default=all dates)
#' @param endDate End date for data pull (default=all dates)
#' @param path The file path (within the working directory) that all data is saved to
#'
#' @return An sf object of USGS gaging stations within given spatial boundary and attributes
#'
#' @seealso [pullFlowUSGS()]
getNWIS <- function(inventory, path, endDate = "", startDate = ""){

  dir.create(file.path(getwd(),"/",path,"/dv/"), showWarnings = FALSE)
  dir.create(file.path(getwd(),"/",path,"/uv/"), showWarnings = FALSE)
  dir.create(file.path(getwd(),"/",path,"/qw/"), showWarnings = FALSE)
  dir.create(file.path(getwd(),"/",path,"/gw/"), showWarnings = FALSE)

  inventory <- inventory %>%
    mutate(combo=paste0(site_no,"-",code))
  
codes <- c("qw","gw","dv","uv")
    
coder <- function(codes){

code_data <- inventory %>%
  dplyr::filter(data_type_cd==codes) %>%
  distinct(.,.keep_all=TRUE)

list <- unique(code_data$combo)

nwis_puller <- function(list){
  
  ind <- dplyr::filter(code_data, combo == list)
  
  dataRetrieval::readNWISdata(sites=unique(ind$site_no), parameterCd=unique(ind$code),
                              service=codes,
                            startDate=ind$begin_date, endDate=ind$end_date) %>%
    write_csv(
      paste0(getwd(),"/",path,"/",codes,"/",unique(ind$site_no),'_',unique(ind$code),'.csv'))
}

purrr::map(list,
    purrr::possibly(nwis_puller, otherwise=1+1))

print(codes, ' data pulled')

}

purrr::map(codes,
           purrr::possibly(coder, otherwise=1+1))
}