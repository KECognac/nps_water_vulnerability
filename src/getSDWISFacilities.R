getSDWISFacilities <- function(park_keys = c("National Historic Trail", "National Historic Site", "National Park", "National Preserve", "National Monument",           
                                             "National Historical Park", "National River", "National Memorial", "National Military Park",      
                                             "National Battlefield", "National Recreation Area", "National Seashore", "National Battlefield Site", "National Lakeshore",          
                                             "National Scenic Trail", "National Wild & Scenic River", "National Battlefield Park", "International Historic Site", "National Trails System",       
                                             "National Reserve", "Parkway", "NPS", "NTNL", "National Park Service"), system = "Mac"){
  
  if(!dir.exists(paste0(getwd(),"/templeod_dataall/"))){dir.create(file.path(getwd(),"/templeod_dataall/"), showWarnings = FALSE)}
  
  options(timeout = 900)
  
  downloadPath <- file.path(paste0(getwd(),"/templeod_dataall/"))
  
  if(system == "PC") {downloadPath <- downloadPath %>% stringr::str_replace_all("/", "\\\\\\\\")}
  
  # make sure server downloads data into appropriate folder (i.e., our temporary folder)
  fprof <- RSelenium::makeFirefoxProfile(list(browser.download.dir = downloadPath,
                                              browser.download.folderList = 2L,
                                              browser.download.manager.showWhenStarting = FALSE,
                                              browser.helperApps.neverAsk.openFile = "text/csv/xlsx",
                                              browser.helperApps.neverAsk.saveToDisk = "text/csv/xlsx"))
  
  exCap <- list(firefox_profile = fprof$firefox_profile)
  # REMOVE  "Pop-up" CONSOLE:
  #"moz:firefoxOptions" = list(args = list('--headless')))
  
  # start up RSelenium session:
  rD <- RSelenium::rsDriver(browser = "firefox", port = sample.int(1000, 1), extraCapabilities = exCap)
  remDr <- rD$client
  
  # get list of all Aquarius sites from the portal
  remDr$navigate('https://sdwis.epa.gov/ords/sfdw_pub/r/sfdw/sdwis_fed_reports_public/103')
  Sys.sleep(3) # provide time for site navigation
  remDr$screenshot(display = TRUE)
  
  dropper <- remDr$findElement(using = 'xpath', value = '//*[@id="irdownload"]')
  Sys.sleep(5) # provide time for navigation and selection
  dropper$clickElement()
  Sys.sleep(120)
  
  # end the RSelenium server session
  remDr$close()
  rD[["server"]]$stop()
  
  temp <- list.files(path = paste0(downloadPath, "/"), pattern = "*.xlsx", full.names = TRUE)
  
  data <- readxl::read_excel(path = temp, skip = 4)
  names(data) <- make.names(names(data))
  
  downloadLink <- "https://irmaservices.nps.gov/datastore/v6/rest/DownloadFile/693182"
  
  #download boundary 
  temp1 <- tempfile()
  download.file(downloadLink, destfile = temp1, method = "curl")
  temp2 <- tempfile()
  unzip(temp1, exdir = temp2)
  
  #sf::sf_use_s2(FALSE)
  
  parks <- sf::st_read(paste0(temp2, "/Administrative_Boundaries_of_National Park_System_Units.gdb")) %>%
    st_join(tigris::counties()) %>%
    left_join(., st_drop_geometry(tigris::states()), by = "STATEFP") %>%
    dplyr::select(UNIT_CODE, UNIT_NAME, PARKNAME, STATE = STUSPS, NAME = NAME.x) %>%
    st_drop_geometry() 

  final_data <- data %>% 
    filter(grepl(paste(park_keys, collapse = "|"), PWS.Name, ignore.case = TRUE)) %>%
    filter(!grepl("turnpike", PWS.Name, ignore.case = TRUE)) %>%
    mutate(STATE = str_sub(PWS.ID, start = 1, end = 2)) %>%
    mutate(NAME = str_split_i(Counties.Served, ", ", i = 1))
  
  # other_data <- data %>% 
  #   filter(grepl(paste(parks$PARKNAME, collapse = "|"), PWS.Name, ignore.case = TRUE)) %>%
  #   filter(!grepl(paste(park_keys, collapse = "|"), PWS.Name, ignore.case = TRUE)) %>%
  #   filter(!grepl("turnpike", PWS.Name, ignore.case = TRUE)) %>%
  #   mutate(STATE = str_sub(PWS.ID, start = 1, end = 2)) %>%
  #   mutate(NAME = str_split_i(Counties.Served, ", ", i = 1))

  correct_sdws <- inner_join(final_data, parks, by = c("STATE", "NAME")) %>%
    dplyr::select(UNIT_CODE, UNIT_NAME, STATE, 
                  COUNTY = NAME,
                  PWS_ID = PWS.ID, 
                  PWS_NAME = PWS.Name, 
                  PWS_TYPE = PWS.Type, 
                  PRIMARY_SOURCE = Primary.Source) #%>%
    #write_csv('sdws_list.csv')
  
  # other_sdws <- inner_join(other_data, parks, by = c("STATE", "NAME")) %>%
  #   dplyr::select(UNIT_CODE, UNIT_NAME, STATE, 
  #                 COUNTY = NAME,
  #                 PWS_ID = PWS.ID, 
  #                 PWS_NAME = PWS.Name, 
  #                 PWS_TYPE = PWS.Type, 
  #                 PRIMARY_SOURCE = Primary.Source) 
  
  # delete the temporary folder
  unlink(file.path(downloadPath), recursive = T)
  
  return(correct_sdws)
  
}
