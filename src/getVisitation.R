#' Retrieve NPS park visitation data
#' 
#' This function uses the IRMA STATS REST Api to pull visitation data for Nation Parks
#' 
#' @param type Either `total` or `park`. Must specify one. `total` returns visitation stats for all U.S. National parks.
#' `park` will get visitation data for specified national parks.
#' @param year If `type = total`, specify the year(s) to get visitation data for. Default is last calendar year. Can supply a string/vector of years
#' @param units If `type = park` the park unit(s) 4 digit code to get visitation for. Can supply a string of park codes or single code.
#' @param startMonth The start month for visitation data, values 1-12. Default is 1 (January).
#' @param startYear The start yeah for visitation data. Default is
#' @param endMonth The end month for visitation data, values 1-12. Default is 12 (December).
#' @param endYear The end year for visitation data
#' @param save Whether to save the resulting file (TRUE/FALSE)
#' @param path If `save = TRUE`, the file path to save to
#' 
#' @return A single dataframe/tibble of visitation statistics, either for all National Parks or specified parks.
#' Dataframe contains visitation numbers for each month of each year.
getVisitation <- function(type, 
                          year = substr(Sys.Date()-365, 1, 4), 
                          units, 
                          startMonth = 1,
                          startYear,
                          endMonth = 12,
                          endYear,
                          save = FALSE,
                          path = NULL) {
  

  #base URL call
  call <- "https://irmaservices.nps.gov/v3/rest/stats"
  
  
  if(type == 'total'){
    
    stats <- vector("list", length = length(year))
    
    for (i in 1:length(year)){
      
      #get stats for all parks for a single year
      dat <- httr::GET(paste0(call, "/total/", year[i]))
      
      # convert content to text
      dat_text <- httr::content(dat, "text", encoding = "UTF-8")
      
      #parse data in JSON
      dat_json <- jsonlite::fromJSON(dat_text, flatten = TRUE)
      
      #convert items to data.frame
      stats[[i]] <- as_tibble(dat_json)

    }
    
   final_df <- bind_rows(stats)
   
   if (save == TRUE){
     
     readr::write_csv(final_df,
                      file = paste0(path,"parkVisitation_total.csv"))
     
   print(paste("Park visitation data saved in:", paste0(getwd(), "/", path)))
     
   }
   
  }
  
  
  if(type == 'park'){
    
    units <- paste0(units, collapse = ",")
    
    dat <- httr::GET(paste0(call, "/visitation?unitCodes=", units, "&startMonth=",
                             startMonth, "&startYear=", startYear, "&endMonth=",
                             endMonth, "&endYear=", endYear))
    
    
    # convert content to text
    dat_text <- httr::content(dat, "text", encoding = "UTF-8")
    
    #parse data in JSON
    dat_json <- jsonlite::fromJSON(dat_text, flatten = TRUE)
    
    #convert items to data.frame
    final_df <- as_tibble(dat_json)
    
    
    if(save == TRUE){
      
      for (i in 1:length(units)){
        
        #create park folder if does not already exist in 'path'
        if (!dir.exists(paste0(path, units[i]))) {
          
          dir.create(paste0(path, units[i]))
        }
        
        # save park boundary in park folder
        sf::st_write(filter(park_boundary, UNIT_CODE == units[i]), 
                     paste0(path, units[i], "/park_boundary_", park[i], ".shp"))
        
        
        readr::write_csv(filter(final_df, UnitCode == units[i]),
                         file = paste0(path, units[i], "/parkVisitation_", units[i], ".csv"))
        
        
      }
      
      print(paste("Park visitation data saved to respective folders in:", paste0(getwd(), "/", path)))
      
      
      
    }
    

  }
  
  return(final_df)
  
  
}
