#' Inventory of WQP sample locations near park units
#' 
#' This function imports an sf polygon object of sample locations within the Water Quality Portal (https://www.waterqualitydata.us/).
#' 
#' @param aoi An sf polygon object, often a park boundary (or boundaries) retrieved from `getParkBoundary()`.
#' @param dist The distance (in the same units used by `getParkBoundary()`) to buffer around park boundary
#' @param save Whether to save the resulting file (TRUE/FALSE)
#' @param path If `save = TRUE`, the file path to save to
#' @return An sf object of WQP sites within given spatial boundary

getWQPData <- function(aoi, dist = 0, save = FALSE, path = NULL){
  
  sf::sf_use_s2(FALSE)
  
  # add buffer around area of interest
  aoi_buffer <- aoi %>% 
    sf::st_buffer(., dist = dist)
  
  counties <- tigris::counties() %>%
    .[aoi_buffer,]
  
  county <- counties$COUNTYNS 
  
  # Identify WQP locations within each county ontained in the AOI
  what_wqp <- function(wqp_site_union){
    
    lister <- function(county){
      
      counties <- counties %>%
        dplyr::filter(COUNTYNS==county)
      
      sites <- dataRetrieval::whatWQPsites(countycode= paste0("US:", counties$STATEFP,":",counties$COUNTYFP)) %>%
        select(-HorizontalAccuracyMeasure.MeasureValue)
      
    }
    
    scat <- purrr::map_dfr(wqp_site_union, lister)
    
  }
  
    # n from USGS: https://github.com/USGS-R/ds-pipelines-targets-example-wqp
  transform_site_locations <- function(sites, crs_out = "WGS84"){
    
    message("Attempting to harmonize different site CRS...")
    
    # Check that crs_out is one of two allowable entries
    if(!crs_out %in% c("WGS84","NAD83"))
      stop("crs_out must be either 'WGS84' or 'NAD83'")
    
    # Define EPSG code for output data frame 
    epsg_out <- case_when(crs_out == "NAD83" ~ 4269,
                          crs_out == "WGS84" ~ 4326)
    
    # Transform sites into a consistent crs defined by epsg_out
    sites_transformed <- sites %>%
      # transform the sites data frame into a list where all sites within each 
      # list element share the same crs/datum
      dplyr::rename(datum = HorizontalCoordinateReferenceSystemDatumName) %>%
      split(.,.$datum) %>%
      # Each list element contains sites with different crs. Transform the sites 
      # within each element to the desired crs
      lapply(., function(x){
        # assume unknown crs (datum equals "UNKNWN", "OTHER") correspond with WGS84
        epsg_in <- dplyr::case_when(unique(x$datum) == "NAD83" ~ 4269,
                                    unique(x$datum) == "WGS84" ~ 4326,
                                    unique(x$datum) == "NAD27" ~ 4267,
                                    unique(x$datum) == "UNKWN" ~ 4326,
                                    unique(x$datum) == "OTHER" ~ 4326)
        
        # convert data frame to sf object and transform to desired crs
        if(!is.na(epsg_in)){
          sites_transformed <- x %>%
            sf::st_as_sf(coords=c("lon","lat"), crs = epsg_in) %>%
            sf::st_transform(epsg_out) %>%
            dplyr::mutate(lon_new = as.numeric(sf::st_coordinates(.)[,1]),
                          lat_new = as.numeric(sf::st_coordinates(.)[,2]),
                          datum_new = crs_out) %>%
            sf::st_drop_geometry() %>%
            dplyr::select(-c(datum)) %>%
            mutate(across(everything(), as.character)) %>%
            dplyr::rename("lon" = "lon_new", "lat" = "lat_new", "datum" = "datum_new")
        } else {
          sites_transformed <- x %>%
            mutate(across(everything(), as.character)) %>%
          message(sprintf("Unable to transform sites with datum = %s; returning sites untransformed",
                          unique(x$datum)))
        }
        return(sites_transformed)
      }) %>%
      # combine transformed sites into a single data frame
      dplyr::bind_rows()
    
    return(sites_transformed)
    
  }
  
  sites <- counties %>% 
    dplyr::mutate(sites=map(COUNTYNS, what_wqp)) %>%
    tidyr::unnest(cols=sites) %>%
    sf::st_drop_geometry() %>%
    dplyr::select(MonitoringLocationIdentifier, OrganizationFormalName, MonitoringLocationTypeName, lat=LatitudeMeasure, lon=LongitudeMeasure, HorizontalCoordinateReferenceSystemDatumName) %>%
    transform_site_locations(., crs_out = "NAD83") %>%
    sf::st_as_sf(coords = c("lon", "lat"), crs = 4269) %>%
    .[aoi_buffer,] %>%
    #sf::st_intersection(., dplyr::select(aoi_buffer, UNIT_CODE)) %>%
    # sf::st_join(., dplyr::select(aoi, UNIT_CODE), left=T) %>%
    # dplyr::mutate(within_park=ifelse(is.na(UNIT_CODE.y), "Outside","Within")) %>%
    dplyr::select(MonitoringLocationIdentifier, OrganizationFormalName, MonitoringLocationTypeName, datum) %>%
    tibble::rowid_to_column(., "index")
    
  site <- sites$MonitoringLocationIdentifier
  
  siter <- function(wqp_data_union){
    
    lister <- function(site){
      
      sites <- sites %>%
        dplyr::filter(MonitoringLocationIdentifier==site)
      
      samples <- dataRetrieval::readWQPdata(siteid=sites$MonitoringLocationIdentifier) %>%
        mutate(across(everything(), as.character)) #%>%
        #saveRDS(paste0('data/all/wqp/raw/',sites$index,'.RDS'))
      
    }
    # site <- wqp_sites$MonitoringLocationIdentifier
    # site <- site[1:1000]
    # purrr::map_dfr(site, lister)
    # 
    scat <- purrr::map_dfr(wqp_data_union, lister)
    
  }
  
  wqp_data <- sites %>% 
    dplyr::mutate(dat=map(MonitoringLocationIdentifier, siter)) %>%
    select(-c(MonitoringLocationIdentifier,OrganizationFormalName)) %>%
    tidyr::unnest() %>%
    sf::st_join(.,aoi_buffer)
    # left_join(sites,by="MonitoringLocationIdentifier")
  
  if(save == TRUE)
  {write.csv(wqp_data, paste0(path,'/wqp_samples.csv'))}
  
  return(wqp_data)
  
}