#' Import historical water balance model data
#' 
#'http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_annual_gridmet_historical_soil_water_2000_2019_annual_means_cropped_units_mm.tif
#' 
#' @param aoi An sf polygon object, often a park boundary (or boundaries) retrieved from `getParkBoundary()`.
#' @param dist The buffer distance (in decimal degrees) around park boundaries to filter data to
#' @param season The season data will be downloaded for. Can be "annual" (default), "winter", "spring", "summer", or "fall".
#' @param path If `save = TRUE`, the file path to save the shapefile
#' 
#' @return A Water Balance rasters masked to each specified area of interest
getWaterBalance <- function(aoi, season = "annual", dist=0){
  
  if(!dir.exists(paste0(getwd(),"data/all/wb_models/"))){dir.create(file.path(getwd(),"data/all/wb_models/"), showWarnings = FALSE)}
  
  sf::sf_use_s2(FALSE)
  
  # AET
  historical_wb <- c(paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_1980_2019_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/AET/historical/V_1_5_", season, "_gridmet_historical_AET_2000_2019_", season, "_means_cropped_units_mm.tif"),
                     # Deficit
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_1980_2019_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/Deficit/historical/V_1_5_", season, "_gridmet_historical_Deficit_2000_2019_", season, "_means_cropped_units_mm.tif"),
                     # PET
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_1980_2019_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/PET/historical/V_1_5_", season, "_gridmet_historical_PET_2000_2019_", season, "_means_cropped_units_mm.tif"),
                     # Rain
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     #paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_1980_2019_", season, "_means_cropped_units_mm.tif")
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/rain/historical/V_1_5_", season, "_gridmet_historical_rain_2000_2019_", season, "_means_cropped_units_mm.tif"),
                     # Accumulated SWE
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_1980_2019_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/accumswe/historical/V_1_5_", season, "_gridmet_historical_accumswe_2000_2019_", season, "_means_cropped_units_mm.tif"),
                     # Runoff
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_1980_2019_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/runoff/historical/V_1_5_", season, "_gridmet_historical_runoff_2000_2019_", season, "_means_cropped_units_mm.tif"),
                     # Soil Water
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_1980_1999_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_1980_2019_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_1981_2010_", season, "_means_cropped_units_mm.tif"),
                     paste0("http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/soil_water/historical/V_1_5_", season, "_gridmet_historical_soil_water_2000_2019_", season, "_means_cropped_units_mm.tif"))
  
  for(i in 1:length(historical_wb)){
    # download datasets 
    
    temp1 <- tempfile()
    
    download.file(paste0(historical_wb[1]), destfile = temp1, method = "curl")
    
    raster <- raster::raster(temp1) %>%
      raster::projectRaster(crs = 4269)
    
    for (i in 1:nrow(aoi)){
      
      aoi_bb <- aoi[i,] %>% 
        sf::st_buffer(dist = dist)

      raster %>%
        raster::mask(.,aoi_bb) %>%
        raster::crop(.,aoi_bb) %>%
        terra::writeRaster(
                         paste0("data/all/wb_models/",
                                aoi_bb$UNIT_CODE,"_",
                                str_match(historical_wb[1], 
                                          paste0(season, "_gridmet_\\s*(.*?)\\s*_", season, "_means"))[,2],
                                ".tif"), overwrite = TRUE)
      
      print(paste0(aoi_bb$UNIT_CODE,"_",
                   str_match(historical_wb[1], 
                             paste0(season,"_gridmet_\\s*(.*?)\\s*_",season))[,2], " done!"))
    }
    
    unlink(temp1)
    
  }

  }
