#' Import NHD data for park
#' 
#' This function uses the nhdplusTools package to import flowline, catchments and
#' water body spatial data for parks, within a specified buffer distance around
#' the park boundary
#' 
#' @param aoi An sf polygon object, often a park boundary (or boundaries) retrieved from `getParkBoundary()`.
#' @param dist The buffer distance (in decimal degrees) around park boundaries to filter NHD data to. 
#' @param save Whether to save (TRUE) the resulting shapefile or not (FALSE)
#' @param path If `save = TRUE`, the file path to save the shapefiles to.
#' 
#' @return A list of spatial sf objects, one for flowlines, cactchments and water bodies
#' 
#' @seealso [getParkBoundary()]
getWatersheds <- function(aoi, dist, save = FALSE, path){
  
  sf::sf_use_s2(FALSE)
  
  # get flowlines in park unit(s)
  #nhd_flowlines <- list()
  
  park_names <- aoi$UNIT_CODE
  
  
  multiple <- function(park_names){
    
    aoi <- filter(aoi, UNIT_CODE==park_names)
    
    
    nhd_flowlines <- nhdplusTools::get_nhdplus(AOI = aoi, 
                                               realization='flowline')
    
    park_flowlines <- nhd_flowlines  %>%
      distinct(comid, .keep_all=TRUE) %>%
      nhdplusTools::get_tocomid(., add=TRUE)
    
    outsiders <- park_flowlines %>%
      filter(tocomid==0) %>% # minimize number of origin points by selecting only those that cross park boundary
      tibble::rowid_to_column(., "index")
    
    nhd <- feather::read_feather('data/all/nhd_tabular.feather') #%>% # read in the complete NHD (in tabular form). This doesn't exist anywhere online that I know of. -_-
    
    # FUNCTION THAT, FOR EVERY POUR POINT, IDENTIFIES ALL UPSTREAM AND DOWNSTREAM FLOWLINES
    watersheds <- function(spid_union){
      tracer <- function(samples){
        outsiders <- as_tibble(outsiders)
        outlet <- outsiders %>%
          dplyr::filter(index == samples)
        upstream <- nhdplusTools::get_UT(nhd, outlet$comid) %>% #upstream trace function in nhdplusTools
          tibble::as_tibble() %>%
          dplyr::rename(comid_list = value) 
        # downstream <- nhdplusTools::get_DM(nhd, outlet$comid) %>% #downstream trace function in nhdplusTools
        #   tibble::as_tibble() %>%
        #   dplyr::rename(comid_list = value)
        # rbind(upstream,downstream) %>%
        distinct(upstream, comid_list, .keep_all = TRUE) %>%
          filter(comid_list != outlet$comid) #%>%
          #write_csv(paste0('data/all/ws_trace/',outlet$comid,'.csv'))
      }
      ws <- map_dfr(spid_union, tracer)
    }
    
    park_ws <- outsiders %>%
      dplyr::mutate(comid_list = map(index, watersheds)) %>%
      # this should work, but it is incredibly slow and I'm not sure why...
      unnest() %>%
      distinct(comid_list) %>%
      sf::st_drop_geometry()
    
    # park_ws <- list.files(path = "data/all/temp/", pattern = "*.csv", full.names = TRUE) %>%
    #   plyr::ldply(., .fun = read_csv) %>%
    #   distinct(comid_list)
    
    # if the previous pour points didn't capture all flowlines within the park, 
    # get traces of flowlines within the park boundary: 
    # if(nrow(park_flowlines %>% filter(!comid %in% park_ws$comid_list)) != 0){
    #   
    #   outsiders <- park_flowlines %>%
    #     filter(!comid %in% park_ws$comid_list) %>%
    #     tibble::rowid_to_column(., "index")
    #   
    #   new_park_ws <- outsiders %>%
    #     dplyr::mutate(comid_list = map(index, watersheds))
    #   
    #   park_ws <- list.files(path = "data/all/temp/", pattern = "*.csv", full.names = TRUE) %>%
    #     plyr::ldply(., .fun = read_csv) %>%
    #     distinct(comid_list)
    # }
    # 
    # get flowlines
    splitter_flowlines <- nhdplusTools::get_nhdplus(comid = outsiders$comid,
                                                    realization='flowline',
                                                    t_srs = 4269) %>%
      select(comid)
    
    nhd_flowlines <- nhdplusTools::get_nhdplus(comid = park_ws$comid_list,
                                               realization='flowline',
                                               t_srs = 4269) %>%
      select(comid) %>%
      bind_rows(splitter_flowlines) %>%
      distinct(comid,.keep_all=TRUE)
    
    grouper <- igraph::components(igraph::graph.adjlist(sf::st_touches(nhd_flowlines)))[[1]] %>%
      as_tibble() %>%
      rename(relationship=value)
    
    grouped_flowlines <- cbind(nhd_flowlines,grouper) %>% 
      group_by(relationship) %>%
      summarize()
    
    # include catchments in the park that are not contained in trace (no NHD flowlines associated with them)
    
    nhd_empty_catchments <- nhdplusTools::get_nhdplus(AOI = aoi, 
                                                      realization='catchment') %>%
      distinct(featureid, .keep_all=TRUE) %>%
      filter(!featureid %in% nhd_flowlines$comid) %>%
      filter(!featureid %in% outsiders$comid) %>%
      mutate(relationship=0) %>%
      select(relationship) %>%
      sf::st_intersection(.,aoi)
    
    splitters <- nhdplusTools::get_nhdplus(comid = outsiders$comid,
                                           realization='catchment',
                                           t_srs = 4269) %>%
      sf::st_intersection(.,aoi)
    
    splitters_flowlines <- nhdplusTools::get_nhdplus(comid = outsiders$comid,
                                                     realization='flowline',
                                                     t_srs = 4269) %>%
      sf::st_intersection(.,aoi)
    
    # get catchments 
    grouped_catchments <- nhdplusTools::get_nhdplus(comid = park_ws$comid_list,
                                                    realization='catchment',
                                                    t_srs = 4269) %>%
      filter(!featureid %in% outsiders$comid) %>%
      bind_rows(splitters) %>%
      sf::st_join(.,grouped_flowlines) %>%
      group_by(relationship) %>%
      summarize() %>%
      bind_rows(nhd_empty_catchments) %>%
      summarize() %>%
      nngeo::st_remove_holes() %>%
      sf::st_join(aoi) %>%
      saveRDS(paste0('data/all/',aoi$UNIT_CODE,'_group_watersheds.RDS'))
    
    
    nhd_flowlines <- nhd_flowlines %>%
      filter(!comid %in% outsiders$comid) %>%
      bind_rows(splitters_flowlines) %>%
      sf::st_join(dplyr::select(grouped_catchments,UNIT_CODE)) %>%
      saveRDS(paste0('data/all/',aoi$UNIT_CODE,'_flowlines.RDS'))
    
  }
  
  map(park_names,multiple)
  
  obj <- list.files(path = "data/all/", pattern = "*group_watersheds.RDS", full.names = TRUE) %>%
    plyr::ldply(., .fun = readRDS)
  
  return(obj)
}