#' Create flowline shapfile(s) for an area of interest.
#' 
#' This function uses the nhdplusTools package to import flowline, catchments and
#' water body spatial data for parks, within a specified buffer distance around
#' the park boundary
#' 
#' @param sf An sf point object.
#' @param save Whether to save (TRUE) the resulting shapefile(s) or not (FALSE)
#' @param path If `save = TRUE`, the file path to save the shapefile(s) to.
#' 
#' @return Watershed shapefile(s) for the aoi
#' 
#' @seealso [getParkBoundary()]
#'
getXYFlowlines <- function(sf = NULL, coordinates = c(-112.2124, 37.63281)){
  
  # KW APPROXIMATE COORDS based on non-digitized maps:
  # BRCA CURRENT EAST CREEK WELLS SUPPLY
  # -112.2124, 37.63281
  # -112.2115, 37.63198
  # BRCA POTENTIAL FUTURE SUPPLY
  # -112.2188, 37.67128
  
  # remotes::install_github("DOI-USGS/nhdplusTools")
  # library(nhdplusTools)
  
  sf::sf_use_s2(FALSE)

  if(is.null(sf)){
    
    # Create a data frame with a column named 'geometry'
    df <- tibble(long = coordinates[1],
                 lat = coordinates[2])
    
    aoi <- sf::st_as_sf(df, coords = c("long", "lat"), crs = 4326)
  }
  
  if(is.null(coordinates)){
    
    aoi <- sf %>% sf::st_transform(4326)
    
  }
  
  aoi <- aoi %>%
    nhdplusTools::get_nhdplus(AOI = .)
  
  
  #### THE get_split_catchment function is broken in nhdplusTools -__-
  # # Use the NHDPlus digital elevation model to find the nearest downslope  
  # # NHD flowline for any point in space (here, our point of interest)
  # # 
  # trace <- nhdplusTools::get_raindrop_trace(aoi, direction = "down") 
  # #
  # # "Snap" our site to the nearest NHD flowline feature
  # snap_point <- sf::st_sfc(sf::st_point(trace$intersection_point[[1]][1:2]),
  #                          crs=4326)
  # #
  # # Clip/split our catchment to only include the portion of the
  # # catchment upstream of our site:
  # better_termination <- get_split_catchment(snap_point, upstream = F)[2,]
  
  # read in the complete NHD (in tabular form) to make for much more efficient nhd crawling. 
  # This data in tabular form doesn't exist anywhere online that I know of... -_-
  nhd <- read_csv('data/all/nhd_flow_network.csv') 
  
  upstream <- nhdplusTools::get_UT(nhd, aoi$comid) %>% #upstream trace function in nhdplusTools
    tibble::as_tibble() %>%
    dplyr::rename(comid_list = value)  %>%
    distinct(comid_list, .keep_all = TRUE)
  
  nhd_flowline <-  upstream$comid_list %>%
    map(~nhdplusTools::get_nhdplus(comid = .,
                                   realization = 'flowline',
                                   t_srs = 4269) %>% dplyr::select(comid)) %>%
    #select(comid) %>%
    bind_rows() %>%
    distinct(comid, .keep_all = TRUE) %>%
    group_by(comid) %>%
    summarize()
  
  return(nhd_flowline)
}


