# This function pulls in historic GridMET data for a selected time frame and area
# of interest.

get_gridMET <- function(path = "data/", 
                        park = "misc", 
                        aoi, 
                        vars = c("tmmx", "tmmn", "pr", "rmax", "rmin", "pet", "etr", "vpd", "vs"), 
                        start = "1979-01-01", 
                        end = "2023-12-31"){
  
  
  # path = "data/"
  # park = "misc" 
  # aoi = watersupply
  # vars <- c("tmmx", "tmmn", "pr", "rmax", "rmin", "pet", "etr", "vpd", "vs") 
  # start = "1979-01-01" 
  # end = "2023-12-31"
  
  if(!dir.exists(paste0(getwd(),"/", path, "/", park))){
    dir.create(file.path(paste0(getwd(),"/", path, "/", park)), showWarnings = FALSE)}
  
  if(!dir.exists(paste0(getwd(),"/", path, "/", park, "/gridmet_hist_monthly/"))){
    dir.create(file.path(paste0(getwd(),"/", path, "/", park, "/gridmet_hist_monthly/")), showWarnings = FALSE)}
  
  for(i in 1:length(vars)){
    
    raw_rast <- climateR::getGridMET(AOI = aoi, 
                                     varname = vars[i], 
                                     startDate = start, 
                                     endDate = end)[[1]]
    
    organized_sub <- raw_rast %>%
      terra::as.data.frame(xy = TRUE) %>%
      data.table::data.table() %>%
      tidyr::pivot_longer(-c(x, y)) %>%
      dplyr::mutate(ym = ym(paste0(str_sub(name, start = -10, end = -4))), 
                    #"-", str_sub(name, start = -5, end = -4))),
                    var = vars[i]) %>%
      dplyr::select(x, y, ym, var, val = value) %>%
      dplyr::group_by(x, y, ym, var) %>%
      # summarize the data to monthly
      dplyr::summarize(sum = sum(val, na.rm=T),
                       mean = mean(val, na.rm=T),
                       min = min(val, na.rm=T),
                       max = max(val, na.rm=T))
    
    rastpath <- paste0(path, "/", park, "/gridmet_hist_monthly/", park, "_gridmet_", 
                       vars[i], "_", start, "_", end, ".csv")
    readr::write_csv(organized_sub, rastpath)
  }
  
  # return list of all data:
  all_gridmet <- list.files(paste0(path, "/", park, "/gridmet_hist_monthly/"), full.names = TRUE) %>%
    map_dfr(~data.table::fread(.)) %>%
    mutate(val = case_when(var %in% c("vpd", "vs", "tmmx", "rmax", "tmmn", "rmin") ~ mean,
                           # is this the right approach?
                           var %in% c("pet", "etr", "pr") ~ sum)) %>%
    select(x, y, ym, var, val) 
  
  return(all_gridmet)
  
}