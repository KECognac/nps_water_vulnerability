# This function pulls in historic GridMET data for a selected time frame and area
# of interest.

get_gridMET <- function(time = "daily",
                        path = "data/", 
                        park = "misc", 
                        aoi = final_aoi, 
                        vars = c("tmmx", "tmmn", "pr", "rmax", "rmin", "pet", "etr", "vpd", "vs"), 
                        start = "1979-01-01", 
                        end = "2022-12-31"){
  
  
  if(time == "monthly"){
  if(!dir.exists(paste0(getwd(),"/", path, "/", park, "/gridmet_hist/"))){dir.create(file.path(paste0(getwd(),"/", path, "/", park, "/gridmet_hist/")), showWarnings = FALSE)}

  if(paste(grepl(paste(vars, collapse = "|"), list.files(paste0(getwd(),"/", path, "/", park, "/gridmet_hist/"), full.names = TRUE)), collapse = " ") != paste(rep(TRUE, length(vars)), collapse = " ")){
  
    print("downloading gridMET files")
    
  #### GRIDMET data
  
  for (i in 1:length(vars)){
    
    options(timeout = 900)
    
    function_lookup <- tibble(varis = c("tmmx", "tmmn", "pr", "rmax", "rmin", "pet", "etr", "vpd", "vs"),
                              fxn = c("max", "min", "sum", "max", "min", "mean", "mean", "mean", "vs")) %>%
      dplyr::filter(varis == vars[i])
    
    raw_rast <- climateR::getGridMET(aoi, varname = vars[i], 
                                     startDate = start, 
                                     endDate = end)[[1]]
    
    organized_sub <- raw_rast %>% #terra::tapp(raw_rast, index = "yearmonths", fun = function_lookup$fxn) %>%
      terra::as.data.frame(xy = TRUE) %>%
      data.table::data.table() %>%
      # group_by()
      pivot_longer(-c(x,y)) %>%
      dplyr::mutate(ym = ym(paste0(str_sub(name, start = -10, end = -7), 
                         "-", str_sub(name, start = -5, end = -4))),
                    variable = vars[i]) %>%
      dplyr::select(x, y, ym, variable, value) %>%
      dplyr::group_by(x, y, ym, variable) %>%
      dplyr:: summarize(sum = sum(value, na.rm=T),
                        mean = mean(value, na.rm=T),
                        min = min(value, na.rm=T),
                        max = max(value, na.rm=T))
    
    
    rastpath <- paste0(path, "/", park, "/gridmet_hist/", park, "_gridmet_", 
                       vars[i], "_", start, "_", end, ".csv")
    write_csv(organized_sub, rastpath)
    
  }
    
  }
    all_gridmet <- list.files(paste0(path, "/", park, "/gridmet_hist/"), recursive = TRUE, full.names = TRUE) %>%
      map_dfr(~read_csv(.)) %>%
      mutate(value = case_when(variable %in% c("tmmx", "rmax") ~ max,
                               variable %in% c("tmmn", "rmin") ~ min,
                               variable %in% c("pet", "etr", "vpd", "vs") ~ mean,
                               variable == "pr" ~ sum)) %>%
      select(x, y, ym, variable, value) %>%
      pivot_wider(names_from = "variable", values_from = "value") 
    
    return(all_gridmet)
    }
  
  
  if(time == "daily"){
    
    if(!dir.exists(paste0(getwd(),"/", path, "/", park, "/gridmet_hist_daily/"))){dir.create(file.path(paste0(getwd(),"/", path, "/", park, "/gridmet_hist_daily/")), showWarnings = FALSE)}
    
    if(paste(grepl(paste(vars, collapse = "|"), list.files(paste0(getwd(),"/", path, "/", park, "/gridmet_hist_daily/"), full.names = TRUE)), collapse = " ") != paste(rep(TRUE, length(vars)), collapse = " ")){
      
      print("downloading gridMET files")
      
      #### GRIDMET data
      
      for (i in 1:length(vars)){
        
        options(timeout = 900)
        
        # function_lookup <- tibble(varis = c("tmmx", "tmmn", "pr", "rmax", "rmin", "pet", "etr", "vpd", "vs"),
        #                           fxn = c("max", "min", "sum", "max", "min", "mean", "mean", "mean", "vs")) %>%
        #   dplyr::filter(varis == vars[i])
        
        raw_rast <- climateR::getGridMET(aoi, varname = vars[i], 
                                         startDate = start, 
                                         endDate = end)[[1]]
        
        organized_sub <- raw_rast %>% #terra::tapp(raw_rast, index = "yearmonths", fun = function_lookup$fxn) %>%
          terra::as.data.frame(xy = TRUE) %>%
          data.table::data.table() %>%
          # group_by()
          pivot_longer(-c(x,y)) %>%
          dplyr::mutate(ym = ymd(paste0(str_sub(name, start = -10, end = -7), 
                                       "-", str_sub(name, start = -5, end = -4),
                                       "-", str_sub(name, start = -2, end = -1))),
                        variable = vars[i]) %>%
          dplyr::select(x, y, ym, variable, value)
        
        rastpath <- paste0(path, "/", park, "/gridmet_hist_daily/", park, "_gridmet_", 
                           vars[i], "_", start, "_", end, ".csv")
        write_csv(organized_sub, rastpath)
        
      }
      
    
    }
    
    all_gridmet <- list.files(paste0(path, "/", park, "/gridmet_hist_daily/"), recursive = TRUE, full.names = TRUE) %>%
      map_dfr(~data.table::fread(.)) %>%
      select(x, y, ym, variable, value) %>%
      pivot_wider(names_from = "variable", values_from = "value") 
    
    return(all_gridmet)
  }
  

}



# mutate(Date = ym,
#        GCM = "gridmet.historical",
#        PrcpIn = pr/25.4,
#        TmaxF = ((tmmx-273.15)*9/5) + 32,
#        TminF = ((tmmn-273.15)*9/5) + 32,
#        RHmaxPct = rmax,
#        RHminPct = rmin,
#        TavgF = (TmaxF+TminF)/2,
#        Year = format(date,"%Y")) %>%
#   dplyr::select(c("Date","GCM","PrcpIn","TmaxF","TminF","RHmaxPct","RHminPct","TavgF","Year")) |>
#   mutate(VPD = VPD(TminF, TmaxF, RHminPct, RHmaxPct),
#          DOY = yday(Date))




# wb_wb_crop <- st_crop(wb_wb, aoi, crop = TRUE) %>% raster::as.data.frame(., xy = TRUE)
# 
# table <- wb_wb_crop %>%
#   left_join(wb_lat, by = c("x", "y")) %>%
#   left_join(wb_lon, by = c("x", "y")) %>%
#   # cant get the projections to line up -_-
#   #st_as_sf(., coords = c("lon", "lat"), crs = 4326) %>%
#   mutate(var = names(.)[4]) %>%
#   rename(val = 4) %>%
#   filter(!is.na(val))
# 
# #mapview(table) + mapview (aoi)
# 
# write_csv(table, file = paste0(getwd(), "/", path, "/", park, "/wbm_hist/", park, "_", map_dat$wb_vars[i], "_", map_dat$years[i], ".csv"))
# terra::writeRaster(test, rastpath, overwrite = TRUE)