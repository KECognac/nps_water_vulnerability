#' Pull metadata from NPS Data Store
#' 
#' This function uses the Data Store REST Api to pull metadata for Nation Parks,
#' specifically  water rights dockets and geospatial datasets.
#' 
#' @param park The park unit(s) 4 digit code you want to pull metadata for
#' @param max The maximum number of entries to return (use a large number to return all entries, default is 1000)
#' @param save Whether to save the resulting file (TRUE/FALSE)
#' @param path If `save = TRUE`, the file path to save to
#' 
#' @return A single dataframe of metadata for each park
inventoryDataStore <- function(park, max = 1000, save = FALSE, path = NULL){
  
  #set base URL
  call <- "https://irmaservices.nps.gov/datastore/v4/rest"
  
  # set up to run over multiple parks
  final_df <- vector("list", length = length(park))
  
  
  for (i in 1:length(park)){
    
    #Search all park info
    dat <- httr::GET(paste0(call, "/QuickSearch?q=", park[i], "&units=", park[i], "&top=", max)) 
    
    #convert content to text
    dat_text <- httr::content(dat, "text", encoding = "UTF-8")
    
    #parse data in JSON
    dat_json <- jsonlite::fromJSON(dat_text, flatten = TRUE)
    
    #convert items to data.frame
    dat_df <- dplyr::as_tibble(dat_json$items)
    
    #filter out dockets and geospatial datasets
    dat_df_clean <- dat_df %>% 
      dplyr::filter(referenceType %in% c("Docket","Geospatial Dataset")) %>% 
      dplyr::mutate(unit = park[i]) %>% 
      dplyr::relocate(unit) %>% 
      dplyr::select(-newestVersion)
    
    
    #create empty vector to fill in resourceID
    resID <- vector("character", length = nrow(dat_df_clean))
    
    #now get resourceID (dataset download ID) for each item
    for (j in 1:nrow(dat_df_clean)){
      
      refID <- as.character(dat_df_clean[j, "referenceId"])
      
      res <- httr::GET(paste0(call, "/Reference/", refID, "/DigitalFiles"))
      
      #extract resourceID
      resContent <- httr::content(res)
      
      # if no file, no resourceID so assign NA
      if(length(resContent) == 0){
        
        resID[j] <- NA
        
      } else {
        
        resID[j] <- purrr::map(resContent, `[[`, 2) %>% 
          unlist() %>% 
          paste(collapse = ",")
      }
      
      
    }
    
    final_df[[i]] <- dat_df_clean %>% 
      dplyr::mutate(resourceId = resID)
    
    
  }
  
  final_df <- dplyr::bind_rows(final_df)
  
  if(save == TRUE){
    readr::write_csv(final_df, file = paste0(path,"/datastore_parkMeta.csv"))
    
  }
  
  
  return(final_df)
  
  
}
