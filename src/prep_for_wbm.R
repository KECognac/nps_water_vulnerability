# Prepare data ahead of inputting into the NPS WBM. Includes grabbing necessary geospatial data for each location of interest.

prep_for_wbm <- function(climate_data = clim_all,
                         col_name = "site_no"){

climate_data <- climate_data %>%
  dplyr::rename("join_index" = paste(sym(col_name)))

points <- unique(climate_data[,c("x", "y", "join_index")]) %>%
  ungroup() %>%
  dplyr::mutate(pt_num = row_number()) %>%
  st_as_sf(., coords = c("x", "y"),
           crs = 4326,
           remove = FALSE)

climate_data <- climate_data %>%
  left_join(., st_drop_geometry(points), by = c("x","y","join_index")) %>%
  data.table()


#' Run NPS water balance model for a given set of points and associated climate
#' data.

print('Loading DEM and soil rasters...')

# DEM (from NPS WBM group) -> in meters
dem <- terra::rast(here::here('data/all/elevation_cropped.tif')) %>%
  terra::project(crs(points))

# Soil storage properties raster (from NPS WBM group)
soil <- terra::rast(here::here('data/all/water_storage.tif')) %>%
  terra::project(crs(points)) * 10 # cm to mm

# Calculate slope & aspect
# For slope, 4 better for "smooth" surfaces, 8 better for rough See:
# https://www.rdocumentation.org/packages/raster/versions/3.1-5/topics/terrain
slope <- terra::terrain(dem, v = "slope",
                        unit = "degrees",
                        neighbors = 8)

aspect <- terra::terrain(dem,
                         v = "aspect",
                         unit = "degrees")


jraster <- terra::rast("data/all/merged_jennings2.tif")

# Extract params for points

print("Extracting params at points...")
points2 <- points %>%
  mutate(Elev = as.numeric(terra::extract(dem, points)$elevation_cropped),
         Aspect = as.numeric(terra::extract(aspect, points)$aspect),
         Slope = as.numeric(terra::extract(slope, points)$slope),
         SWC.Max = as.numeric(terra::extract(soil, points)$water_storage),
         jtemp = as.numeric(terra::extract(jraster, points)$merged_jennings2_1)) %>%
  st_drop_geometry() %>%
  data.table()

return(list(climate_data,
            points2))

}
