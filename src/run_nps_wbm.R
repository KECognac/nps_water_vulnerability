run_nps_wbm <- function(prepped_data,
                        col_name, # what the original column name was that was used for grouping 
                        PET_Method = c("Oudin"),
                        hock_coef = 4,
                        Snowpack.Init = 0, # according to Mike's code
                        Soil.Init = 0, # Init full from Mike's code, empty in Ambers
                        Shade.Coeff = 1,
                        T.Base = 0) {

  # # Code for testing:
  # prepped_data <- prep_for_wbm(read_csv("data/all/CollectionofHydSaxe2021/EASTERN TEMPERATE FORESTS_010010202002.csv") %>% mutate(loc = paste(x, "_", y)), col_name = "loc")
  # PET_Method <- "Oudin"
  # hock_coef <-  4
  # Snowpack.Init <- 0   # according to Mike's code
  # Soil.Init <- 0 # Init full from Mike's code, empty in Ambers
  # Shade.Coeff <- 1
  # T.Base <- 0
  # col_name = "loc"

  climate_data <- prepped_data[[1]]

  points2 <- prepped_data[[2]] %>%
    dplyr::mutate(Snowpack.Init = Snowpack.Init,   # according to Mike's code
                  Soil.Init = Soil.Init, # Init full from Mike's code, empty in Ambers
                  Shade.Coeff = Shade.Coeff)

  # Now, run WBM

  print("Running wbm...")

  calculator <- function(pt_nums){
    start = Sys.time()
    point <- data.table(points2) %>% dplyr::filter(pt_num == pt_nums)
    DailyWB <- data.table(climate_data) %>% dplyr::filter(pt_num == pt_nums)
    DailyWB$doy <- yday(DailyWB$date)
    DailyWB$daylength <- get_daylength(DailyWB$date, point$y)
    DailyWB$jtemp = point$jtemp
    DailyWB$F = get_freeze(DailyWB$jtemp, DailyWB$tmean_C)
    DailyWB$RAIN = get_rain(DailyWB$ppt_mm, DailyWB$F)
    DailyWB$SNOW = get_snow(DailyWB$ppt_mm, DailyWB$F)
    DailyWB$MELT = get_melt(DailyWB$tmean_C, DailyWB$jtemp, hock=hock_coef, DailyWB$SNOW, point$Snowpack.Init)
    DailyWB$PACK = get_snowpack(DailyWB$jtemp, DailyWB$SNOW, DailyWB$MELT)
    DailyWB$W = DailyWB$MELT + DailyWB$RAIN
    if(PET_Method == "Hamon"){
      DailyWB$PET = ET_Hamon_daily(DailyWB)
    } else {
      if(PET_Method == "Penman-Monteith"){
        DailyWB$PET = ET_PenmanMonteith_daily(DailyWB)
      } else {
        if(PET_Method == "Oudin"){
          DailyWB$PET = get_OudinPET(DailyWB$doy, point$y, DailyWB$PACK,
                                     DailyWB$tmean_C, point$Slope,
                                     point$Aspect, point$Shade.Coeff)
        } else {
          print("Error - PET method not found")
        }
      }
    }
    #DailyWB$PET_mod = modify_PET(DailyWB$PET, DailyWB$Slope, DailyWB$Aspect,
    #                         DailyWB$Lat, DailyWB$Shade.Coeff)
    DailyWB$PET_mod <- DailyWB$PET
    DailyWB$W_PET = DailyWB$W - DailyWB$PET_mod
    DailyWB$SOIL = get_soil(DailyWB$W, point$Soil.Init, DailyWB$PET_mod,
                            DailyWB$W_PET, point$SWC.Max)
    DailyWB$DSOIL = diff(c(point$Soil.Init, DailyWB$SOIL))
    DailyWB$AET = get_AET(DailyWB$W, DailyWB$PET_mod, DailyWB$SOIL, point$Soil.Init)
    DailyWB$W_ET_DSOIL = DailyWB$W - DailyWB$AET - DailyWB$DSOIL
    DailyWB$D = DailyWB$PET_mod - DailyWB$AET
    DailyWB$GDD = get_GDD(DailyWB$tmean_C, T.Base)

    DailyWB_ret <- DailyWB %>%
      data.table() %>%
      ungroup() %>%
      dplyr::select(date, x, y, pt_num, PR = ppt_mm, RUNOFF = W_ET_DSOIL, RAIN, SNOW, MELT) %>%
      pivot_longer(-c(date, x, y, pt_num), values_to = "vals", names_to = "vars") %>%
      mutate(join_index = point$join_index)
    end = Sys.time()
    print(paste0(end-start, " for calculating the WBM variables"))
    
    return(DailyWB_ret)

    # if (i == 1) {
    #   all_wb <- DailyWB_ret
    # } else if (i > 1) {
    #   all_wb <- all_wb %>%
    #     bind_rows(., DailyWB_ret)
    # }

  }

  start = Sys.time()
  wbm_data <- points2$pt_num %>%
    map(~ calculator(.x)) %>%
    bind_rows() %>%
     #})
    data.table() %>%
    mutate(vals = vals * 0.0393701) %>% # convert all vals from mm to in
    pivot_wider(names_from = vars, values_from = vals) %>%
    dplyr::rename(runoff_in_wbm = RUNOFF,
                  rain_in_wbm = RAIN,
                  snow_in_wbm = SNOW,
                  melt_in_wbm = MELT,
                  precip_in_wbm = PR) %>%
    #mutate(site_no = site_no) %>%
    dplyr::select(-c(x, y, pt_num)) %>%
    group_by(date, join_index) %>%
    summarize_all(., .funs = mean)  # daily mean of all points

  # Rename the join_index column
  colnames(wbm_data)[colnames(wbm_data) == "join_index"] <- paste(sym(col_name))
  end = Sys.time()
  print(paste0(end-start, " minutes for calculating the WBM variables"))

  return(wbm_data)

}

