---
title: "NPS Water Balance vs BCM"
author: "Katie Willi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("setup.R")
```

This is an R workflow to pull in monthly data from the USGS California Water Science Center's Basin Characterization Model (BCM). The BCM is a water balance model that uses climate, vegetation, soil, and geologic properties to calculate localized watershed discharge and watershed groundwater recharge.

of downscaled PRISM climate data, Priestly Taylor's Potential Evapotranspiration (PET); 1980-2023

**Downloading California Park Boundaries**

Using our `getParkSystem()` function to pull in the NPS's most current [park boundaries on Irma](https://irma.nps.gov/DataStore/Reference/Profile/2224545?lnv=True):

```{r}
ca_parks <- getParkSystem() %>%
  filter(STATE == "CA")
```

Map of all National Parks in California:

```{r}
mapview(ca_parks)
```

**Downloading and cropping the BCM model outputs**

The BCM model is a water balance model that s 1980-2020:

```{r}
urls <- c(
  # Recharge 
  # 1980-1990
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__e8%2F9e%2Ff8%2Fe89ef8d80aace3b9068a2949ce502765053db96a",
  # 1990-2000
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__12%2Fe2%2Fd8%2F12e2d8aff0903318721940e090e6bcf3fdf47ab4",
  # 2000-2010
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__8a%2Fd7%2F3b%2F8ad73b1ae1e95874e6eba74ac6c017864db1700d",
  # 2010-2020
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__89%2F9e%2F6f%2F899e6f7379a244b2ead148f0ae5c69db2196224b",
  # Runoff
  # 1980-1990
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__d1%2Ffa%2Fdc%2Fd1fadc75f3288e91bba92321385dcf16537ce2d1",
  # 1990-2000
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__0b%2F3a%2Fe2%2F0b3ae299d061cbfd81f5f91b6d61b39eea65f271",
  # 2000-2010
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__d2%2F30%2F2c%2Fd2302ca9b11d26a23433ca5ac97c9fdcd7e3edcf",
  # 2010-2020
  "https://www.sciencebase.gov/catalog/file/get/5f29c62d82cef313ed9edb39?f=__disk__5c%2Fd4%2Ffc%2F5cd4fc62f34cbb240790a126f9167f7b4564dc68")

bcm_downloader<-function(url){
  temp1 <- tempfile()
  download.file(paste0(url), destfile = temp1, method = "curl")
  unzip(temp1, exdir = "data/california_data/bcm_hist/")
}

walk(urls, bcm_downloader)

bcm_cropper <- function(files, aoi){

  wb_crop <- terra::rast(paste0("data/california_data/bcm_hist/", files[1]))

    aoi <- aoi %>%
      sf::st_transform(terra::crs(wb_crop))

    wb_crop <- wb_crop %>%
      terra::crop(aoi, mask = TRUE)

    terra::writeRaster(wb_crop, filename = paste0(getwd(), "data/california_data/cropped_bcm_hist/", files, ".tif"),
                       overwrite = TRUE)
}

list.files('data/california_data/bcm_hist') %>%
  walk(~bcm_cropper(files = ., aoi = ca_parks))

```

**Downloading and cropping the NPS water balance model data**

Here, we download the monthly runoff and recharge outputs from the NPS Water Balance Model for the years 1980-2020. This data was downloaded from the [What Water Balance Model Do You Need](http://www.yellowstone.solutions/thredds/catalog/daily_or_monthly/v2_historical/gridmet_v_1_5_historical/catalog.html) service.

```{r}
getHistoricWBM(park = "california_data", aoi = summarize(ca_parks), path = "data/", wb_vars = c("runoff"))


```
